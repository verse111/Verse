<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>'VERSE Poetry & Story Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Dancing+Script:wght@700&family=Noto+Sans+Myanmar:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        :root {
            --primary: #6C63FF;
            --secondary: #FF6584;
            --accent: #36D1DC;
            --light: #f8f9fa;
            --dark: #121826;
            --glass-light: rgba(255, 255, 255, 0.3);
            --glass-dark: rgba(18, 24, 38, 0.7);
            --text-light: #333;
            --text-dark: #f8f9fa;
            --card-light: rgba(255, 255, 255, 0.8);
            --card-dark: rgba(255, 255, 255, 0.2);
        }

        body {
            font-family: 'Poppins', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body.light-mode {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-light) !important;
        }

        body.light-mode * {
            color: var(--text-light) !important;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: var(--text-dark) !important;
        }

        body.dark-mode * {
            color: var(--text-dark) !important;
        }

        /* NEW: Buy Coins Button */
        .buy-coins-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.5);
            z-index: 100;
            transition: all 0.3s;
            border: 2px solid rgba(255, 255, 255, 0.5);
            animation: pulseGold 2s infinite;
        }

        .buy-coins-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.7);
        }

        .buy-coins-btn a {
            color: #333;
            text-decoration: none;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Noto Sans Myanmar', sans-serif;
        }

        .buy-coins-btn i {
            font-size: 1.2rem;
            color: #333;
        }

        @keyframes pulseGold {
            0% { box-shadow: 0 5px 20px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 5px 25px rgba(255, 215, 0, 0.8); }
            100% { box-shadow: 0 5px 20px rgba(255, 215, 0, 0.5); }
        }

        /* Mobile responsive for buy coins button */
        @media (max-width: 768px) {
            .buy-coins-btn {
                bottom: 100px;
                left: 20px;
                padding: 12px 20px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .buy-coins-btn {
                bottom: 90px;
                left: 15px;
                padding: 10px 16px;
                font-size: 0.8rem;
            }
        }

        /* Fix light mode text visibility */
        body.light-mode .card-content h3,
        body.light-mode .card-content p,
        body.light-mode .user-info,
        body.light-mode .coin-display,
        body.light-mode .detail-header h1,
        body.light-mode .detail-header p,
        body.light-mode .detail-content,
        body.light-mode .item-title,
        body.light-mode .item-author,
        body.light-mode .item-preview,
        body.light-mode .search-bar input,
        body.light-mode .back-btn,
        body.light-mode .upload-form,
        body.light-mode .upload-header h3,
        body.light-mode .upload-header p,
        body.light-mode .form-group input,
        body.light-mode .form-group textarea,
        body.light-mode .profile-card,
        body.light-mode .profile-info h3,
        body.light-mode .profile-info p,
        body.light-mode .stat-item,
        body.light-mode .my-item-title,
        body.light-mode .notification {
            color: var(--text-light) !important;
        }

        /* Fix light mode input placeholders */
        body.light-mode .form-group input::placeholder,
        body.light-mode .form-group textarea::placeholder,
        body.light-mode .search-bar input::placeholder {
            color: rgba(51, 51, 51, 0.7) !important;
        }

        .bubbles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }

        .bubble {
            position: absolute;
            bottom: -100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: rise 15s infinite ease-in;
        }

        @keyframes rise {
            0% {
                bottom: -100px;
                transform: translateX(0);
            }
            50% {
                transform: translateX(100px);
            }
            100% {
                bottom: 110%;
                transform: translateX(-100px);
            }
        }

        /* Glass Card Style */
        .glass-card {
            width: 240px;
            height: 360px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(29px);
            -webkit-backdrop-filter: blur(29px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.5),
                inset 0 -1px 0 rgba(255, 255, 255, 0.1),
                inset 0 0 16px 8px rgba(255, 255, 255, 0.8);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .glass-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.8),
                transparent
            );
        }

        .glass-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 1px;
            height: 100%;
            background: linear-gradient(
                180deg,
                rgba(255, 255, 255, 0.8),
                transparent,
                rgba(255, 255, 255, 0.3)
            );
        }

        /* Theme Toggle Button */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .theme-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .theme-btn:hover {
            transform: rotate(30deg);
            background: rgba(255, 255, 255, 0.3);
        }

        body.light-mode .theme-btn {
            color: var(--text-light);
        }

        /* 'VERSE Logo Animation */
        .verse-logo {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 2000;
            animation: fadeOut 2s ease-in-out 2s forwards;
        }

        .verse-text {
            font-family: 'Dancing Script', cursive;
            font-size: 8rem;
            background: linear-gradient(45deg, #FF6584, #6C63FF, #36D1DC);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 10px rgba(108, 99, 255, 0.5); }
            to { text-shadow: 0 0 20px rgba(255, 101, 132, 0.8), 0 0 30px rgba(54, 209, 220, 0.6); }
        }

        @keyframes fadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; visibility: hidden; }
        }

        /* Auth Container */
        .auth-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1500;
            align-items: center;
            justify-content: center;
        }

        .auth-box {
            width: 400px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        body.light-mode .auth-header {
            color: var(--text-light);
        }

        .auth-header h2 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            cursor: pointer;
            color: white;
            font-weight: 500;
            transition: all 0.3s;
        }

        body.light-mode .auth-tab {
            color: var(--text-light);
        }

        .auth-tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary) !important;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            outline: none;
            transition: border 0.3s;
        }

        body.light-mode .form-group input {
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-light);
            border: 1px solid rgba(0, 0, 0, 0.2);
        }

        .form-group input:focus {
            border-color: var(--primary);
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .auth-btn:hover {
            transform: translateY(-3px);
        }

        /* Dashboard */
        .dashboard {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin-bottom: 40px;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .user-info:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        body.light-mode .user-info {
            color: var(--text-light);
            background: rgba(255, 255, 255, 0.8);
        }

        body.light-mode .user-info:hover {
            background: rgba(255, 255, 255, 0.9);
            border-color: var(--primary);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            color: white !important;
            border: 3px solid rgba(255, 255, 255, 0.5);
        }

        .coin-display {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            border: 2px solid gold;
        }

        body.light-mode .coin-display {
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-light);
            border: 2px solid #DAA520;
        }

        .coin-display i {
            color: gold;
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Logout Button */
        .logout-btn {
            background: rgba(255, 101, 132, 0.2);
            border: 1px solid rgba(255, 101, 132, 0.5);
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }

        body.light-mode .logout-btn {
            background: rgba(255, 101, 132, 0.1);
            color: var(--text-light);
            border: 1px solid rgba(255, 101, 132, 0.3);
        }

        .logout-btn:hover {
            background: rgba(255, 101, 132, 0.3);
        }

        body.light-mode .logout-btn:hover {
            background: rgba(255, 101, 132, 0.2);
        }

        .selection-container {
            display: flex;
            justify-content: center;
            gap: 50px;
            margin-top: 50px;
        }

        .selection-card {
            position: relative;
        }

        .card-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            padding: 20px;
        }

        body.light-mode .card-content {
            color: var(--text-light);
        }

        .card-content h3 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-family: 'Dancing Script', cursive;
        }

        .card-content p {
            font-size: 1rem;
            opacity: 0.9;
        }

        /* Poem List */
        .poem-list-container, .novel-list-container {
            display: none;
            padding: 20px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            transition: background 0.3s;
        }

        body.light-mode .back-btn {
            background: rgba(0, 0, 0, 0.1);
            color: var(--text-light);
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        body.light-mode .back-btn:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        .search-bar {
            width: 100%;
            max-width: 500px;
            margin: 0 auto 30px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            outline: none;
        }

        body.light-mode .search-bar input {
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-light);
            border: 1px solid rgba(0, 0, 0, 0.2);
        }

        .search-bar i {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 1.2rem;
        }

        body.light-mode .search-bar i {
            color: var(--text-light);
        }

        /* ENHANCED MOBILE RESPONSIVE DESIGN */
        .poems-grid, .novels-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        /* Mobile optimization - 2 items per row */
        @media (max-width: 768px) {
            .poems-grid, .novels-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                padding: 10px;
            }
            
            .poem-item, .novel-item {
                padding: 12px;
                height: auto;
                min-height: 200px;
                max-height: 240px;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            
            .item-image {
                height: 80px !important;
                min-height: 80px;
                width: 100%;
                object-fit: cover;
                border-radius: 8px;
                margin-bottom: 8px;
            }
            
            /* Mobile: Title limited to about 10 characters */
            .item-title {
                font-size: 0.85rem !important;
                margin-bottom: 4px;
                line-height: 1.2;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
                max-width: 100%;
                display: block;
            }
            
            .item-author {
                font-size: 0.7rem !important;
                margin-bottom: 5px;
            }
            
            .item-preview {
                -webkit-line-clamp: 2;
                font-size: 0.75rem !important;
                line-height: 1.3;
                flex-grow: 1;
                overflow: hidden;
                margin-bottom: 5px;
                word-break: break-word;
                min-height: 2.6em;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
            }
            
            /* NEW: Mobile rating section visibility fix */
            .novel-item .rating-section {
                display: flex !important;
                flex-direction: row;
                align-items: center;
                gap: 8px;
                margin-top: 5px;
                font-size: 0.7rem;
                flex-shrink: 0;
            }
            
            .novel-item .stars {
                display: flex;
                gap: 2px;
            }
            
            .novel-item .star-btn {
                font-size: 0.65rem !important;
                padding: 1px;
            }
            
            .novel-item .average-rating {
                font-size: 0.7rem !important;
                display: flex;
                align-items: center;
                gap: 2px;
            }
            
            .novel-item .rating-count {
                font-size: 0.65rem !important;
            }
            
            .like-section {
                margin-top: 5px;
                font-size: 0.75rem !important;
            }
            
            /* Tablet view */
            @media (min-width: 480px) and (max-width: 768px) {
                .poems-grid, .novels-grid {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 15px;
                }
                
                .poem-item, .novel-item {
                    min-height: 220px;
                    max-height: 260px;
                }
                
                .item-image {
                    height: 100px !important;
                }
                
                .item-title {
                    font-size: 0.9rem !important;
                }
                
                .item-preview {
                    font-size: 0.8rem !important;
                }
                
                .novel-item .rating-section {
                    gap: 10px;
                }
                
                .novel-item .star-btn {
                    font-size: 0.75rem !important;
                }
            }
            
            /* Make selection cards stack on very small screens */
            @media (max-width: 480px) {
                .selection-container {
                    flex-direction: column;
                    align-items: center;
                    gap: 30px;
                }
                
                .glass-card {
                    width: 280px;
                    height: 400px;
                }
                
                /* Very small screens: even shorter title */
                .item-title {
                    max-width: 90px;
                    font-size: 0.8rem !important;
                }
                
                /* Extra small screen rating adjustment */
                .novel-item .rating-section {
                    gap: 5px;
                }
                
                .novel-item .stars {
                    gap: 1px;
                }
                
                .novel-item .star-btn {
                    font-size: 0.6rem !important;
                }
            }
        }

        /* Tablet optimization */
        @media (min-width: 769px) and (max-width: 1024px) {
            .poems-grid, .novels-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
            }
        }

        /* Desktop optimization */
        @media (min-width: 1025px) {
            .poems-grid, .novels-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 20px;
            }
        }

        .poem-item, .novel-item {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: transform 0.3s, background 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            word-wrap: break-word;
        }

        body.light-mode .poem-item,
        body.light-mode .novel-item {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .poem-item:hover, .novel-item:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
        }

        body.light-mode .poem-item:hover,
        body.light-mode .novel-item:hover {
            background: rgba(255, 255, 255, 0.9);
        }

        .item-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .item-title {
            font-size: 1.1rem;
            color: white;
            margin-bottom: 8px;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }

        body.light-mode .item-title {
            color: var(--text-light);
        }

        .item-author {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
        }

        .item-author a {
            color: var(--accent);
            text-decoration: none;
            transition: color 0.3s;
        }

        .item-author a:hover {
            color: var(--primary);
            text-decoration: underline;
        }

        body.light-mode .item-author {
            color: rgba(0, 0, 0, 0.7);
        }

        .item-preview {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            flex-grow: 1;
            word-break: break-word;
            margin-bottom: 8px;
        }

        body.light-mode .item-preview {
            color: rgba(0, 0, 0, 0.8);
        }

        /* Like Button */
        .like-section {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: auto;
            flex-shrink: 0;
        }

        .like-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 1.1rem;
            transition: color 0.3s, transform 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        body.light-mode .like-btn {
            color: rgba(0, 0, 0, 0.7);
        }

        .like-btn.liked {
            color: #ff4757 !important;
            animation: heartBeat 0.5s;
        }

        body.light-mode .like-btn.liked {
            color: #ff4757 !important;
        }

        .like-btn:hover {
            color: #ff4757;
            transform: scale(1.1);
        }

        body.light-mode .like-btn:hover {
            color: #ff4757;
        }

        .like-count {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        body.light-mode .like-count {
            color: rgba(0, 0, 0, 0.8);
        }

        @keyframes heartBeat {
            0% { transform: scale(1); }
            25% { transform: scale(1.3); }
            50% { transform: scale(1); }
            75% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Rating System - FIXED FOR MOBILE VISIBILITY */
        .rating-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .stars {
            display: flex;
            gap: 3px;
        }

        .star-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            font-size: 1.1rem;
            transition: color 0.3s, transform 0.2s;
            padding: 2px;
        }

        .star-btn.active {
            color: gold !important;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }

        .star-btn:hover {
            color: gold;
            transform: scale(1.1);
        }

        body.light-mode .star-btn {
            color: rgba(0, 0, 0, 0.3);
        }

        body.light-mode .star-btn.active {
            color: gold !important;
        }

        body.light-mode .star-btn:hover {
            color: gold;
        }

        .average-rating {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        body.light-mode .average-rating {
            color: rgba(0, 0, 0, 0.8);
        }

        .rating-count {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
        }

        body.light-mode .rating-count {
            color: rgba(0, 0, 0, 0.6);
        }

        /* Coin Cost Indicator - UPDATED: 8 coins to author, 2 coins platform fee */
        .coin-cost-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 215, 0, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: gold;
            flex-shrink: 0;
        }

        body.light-mode .coin-cost-indicator {
            background: rgba(255, 215, 0, 0.3);
            color: #DAA520;
        }

        /* NEW: Coin Payment Success Banner */
        .coin-payment-success {
            display: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.9), rgba(255, 165, 0, 0.9));
            backdrop-filter: blur(10px);
            color: #333;
            padding: 15px 30px;
            border-radius: 50px;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.5s ease-out, fadeOut 0.5s ease-out 3s forwards;
            border: 3px solid rgba(255, 255, 255, 0.5);
        }

        .coin-payment-success-content {
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 600;
        }

        .coin-payment-success i {
            font-size: 1.8rem;
            color: #4CAF50;
        }

        @keyframes slideDown {
            from {
                top: -100px;
                opacity: 0;
            }
            to {
                top: 20px;
                opacity: 1;
            }
        }

        /* Author Profile Button */
        .author-profile-btn {
            background: rgba(108, 99, 255, 0.2);
            border: 1px solid rgba(108, 99, 255, 0.5);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            transition: all 0.3s;
            margin-top: 10px;
            flex-shrink: 0;
        }

        body.light-mode .author-profile-btn {
            background: rgba(108, 99, 255, 0.1);
            color: var(--text-light);
            border: 1px solid rgba(108, 99, 255, 0.3);
        }

        .author-profile-btn:hover {
            background: rgba(108, 99, 255, 0.3);
            transform: translateY(-2px);
        }

        /* Poem Detail */
        .poem-detail-container, .novel-detail-container {
            display: none;
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
        }

        .detail-header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        body.light-mode .detail-header {
            color: var(--text-light);
        }

        .detail-header .like-section,
        .detail-header .rating-section {
            justify-content: center;
            margin-top: 15px;
        }

        /* NEW: Category and Date Info */
        .detail-meta-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .detail-category, .detail-date {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        body.light-mode .detail-category,
        body.light-mode .detail-date {
            background: rgba(0, 0, 0, 0.1);
            color: rgba(0, 0, 0, 0.8);
        }

        .author-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            max-width: 300px;
            margin: 20px auto;
        }

        .author-section:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
            color: white !important;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .author-name {
            font-weight: 600;
            color: var(--accent);
        }

        .detail-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .detail-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            color: white;
            line-height: 1.8;
            font-size: 1.1rem;
            white-space: pre-line;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow-x: hidden;
        }

        /* Mobile responsive for detail content */
        @media (max-width: 768px) {
            .detail-content {
                padding: 20px;
                font-size: 0.95rem !important;
                line-height: 1.6;
                max-height: none;
                overflow-y: visible;
            }
            
            .detail-header h1 {
                font-size: 1.5rem !important;
            }
            
            .detail-meta-info {
                gap: 10px;
            }
            
            .detail-category, .detail-date {
                font-size: 0.8rem !important;
                padding: 6px 12px;
            }
        }

        body.light-mode .detail-content {
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-light);
        }

        /* Upload Container */
        .upload-container {
            display: none;
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
        }

        .upload-form {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            color: white;
        }

        body.light-mode .upload-form {
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-light);
        }

        .upload-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .upload-header .user-avatar {
            width: 40px;
            height: 40px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 20px;
            transition: border-color 0.3s;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        body.light-mode .upload-area {
            border: 2px dashed rgba(0, 0, 0, 0.3);
        }

        .upload-area:hover {
            border-color: var(--primary);
        }

        .upload-area i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.5);
        }

        body.light-mode .upload-area i {
            color: rgba(0, 0, 0, 0.5);
        }

        .image-preview {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        /* FIX: Upload progress indicator */
        .upload-progress {
            display: none;
            width: 80%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-top: 15px;
            overflow: hidden;
        }

        .upload-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            width: 0%;
            transition: width 0.3s;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            resize: vertical;
            outline: none;
            word-wrap: break-word;
        }

        body.light-mode textarea {
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-light);
            border: 1px solid rgba(0, 0, 0, 0.2);
        }

        .upload-btn {
            background: linear-gradient(45deg, var(--primary), var(--accent));
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px auto 0;
            transition: transform 0.3s;
        }

        .upload-btn:hover {
            transform: translateY(-3px);
        }

        .upload-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .coin-cost {
            text-align: center;
            color: gold;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        /* Floating Add Button - FIXED */
        .floating-add-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(108, 99, 255, 0.5);
            z-index: 100;
            transition: transform 0.3s;
        }

        .floating-add-btn:hover {
            transform: scale(1.1);
        }

        /* Profile Container */
        .profile-container {
            display: none;
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
        }

        .profile-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            color: white;
            margin-bottom: 30px;
            border: 3px solid var(--primary);
            box-shadow: 0 10px 30px rgba(108, 99, 255, 0.3);
        }

        body.light-mode .profile-card {
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-light);
            border: 3px solid var(--primary);
            box-shadow: 0 10px 30px rgba(108, 99, 255, 0.2);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: white !important;
            border: 5px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .profile-info h3 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: var(--accent);
        }

        .profile-info p {
            color: rgba(255, 255, 255, 0.7);
        }

        body.light-mode .profile-info p {
            color: rgba(0, 0, 0, 0.7);
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .stat-item:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
        }

        body.light-mode .stat-item {
            background: rgba(0, 0, 0, 0.05);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .my-poems, .my-novels {
            margin-top: 30px;
        }

        .my-poems h4, .my-novels h4 {
            margin-bottom: 20px;
            font-size: 1.5rem;
            color: var(--accent);
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
        }

        body.light-mode .my-poems h4,
        body.light-mode .my-novels h4 {
            border-bottom: 2px solid rgba(0, 0, 0, 0.2);
        }

        .my-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        @media (max-width: 768px) {
            .my-items-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .my-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .my-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        body.light-mode .my-item {
            background: rgba(0, 0, 0, 0.05);
        }

        body.light-mode .my-item:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .my-item-title {
            font-weight: 500;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .item-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 1.1rem;
            transition: color 0.3s;
            padding: 5px;
            border-radius: 5px;
        }

        body.light-mode .action-btn {
            color: rgba(0, 0, 0, 0.7);
        }

        .action-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        body.light-mode .action-btn:hover {
            color: black;
            background: rgba(0, 0, 0, 0.1);
        }

        .edit-btn:hover {
            color: var(--accent);
        }

        body.light-mode .edit-btn:hover {
            color: var(--accent);
        }

        .delete-btn:hover {
            color: var(--secondary);
        }

        body.light-mode .delete-btn:hover {
            color: var(--secondary);
        }

        /* User Profile Container */
        .user-profile-container {
            display: none;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .user-profile-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            color: white;
            border: 3px solid var(--accent);
            word-wrap: break-word;
        }

        body.light-mode .user-profile-content {
            background: rgba(255, 255, 255, 0.95);
            color: var(--text-light);
            border: 3px solid var(--accent);
            box-shadow: 0 10px 30px rgba(54, 209, 220, 0.2);
        }

        .user-profile-header {
            display: flex;
            align-items: center;
            gap: 25px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        body.light-mode .user-profile-header {
            border-bottom: 2px solid rgba(0, 0, 0, 0.2);
        }

        .user-profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: white !important;
            border: 5px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .user-profile-info h3 {
            font-size: 2rem;
            margin-bottom: 8px;
            color: var(--accent);
        }

        .user-profile-info p {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
            font-size: 0.95rem;
        }

        body.light-mode .user-profile-info p {
            color: rgba(0, 0, 0, 0.7);
        }

        .user-profile-stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .user-profile-stat {
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px 20px;
            border-radius: 12px;
            min-width: 100px;
            flex: 1;
        }

        body.light-mode .user-profile-stat {
            background: rgba(0, 0, 0, 0.05);
        }

        .user-profile-stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .user-profile-stat-label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        body.light-mode .user-profile-stat-label {
            color: rgba(0, 0, 0, 0.7);
        }

        .user-content-section {
            margin-top: 40px;
        }

        .user-content-section h4 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--accent);
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
        }

        body.light-mode .user-content-section h4 {
            border-bottom: 2px solid rgba(0, 0, 0, 0.2);
        }

        .user-content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        @media (max-width: 768px) {
            .user-content-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .user-profile-header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .user-profile-stats {
                flex-direction: column;
                gap: 15px;
            }
            
            .user-profile-stat {
                min-width: auto;
                width: 100%;
            }
        }

        .user-content-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .user-content-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent);
            transform: translateY(-3px);
        }

        body.light-mode .user-content-item {
            background: rgba(0, 0, 0, 0.05);
        }

        body.light-mode .user-content-item:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .user-content-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .user-content-title {
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.3;
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            min-height: 2.6em;
        }

        .user-content-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        body.light-mode .user-content-meta {
            color: rgba(0, 0, 0, 0.7);
        }

        .user-content-meta i {
            margin-right: 3px;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
            border-radius: 10px;
            padding: 15px 25px;
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 2000;
            transform: translateX(150%);
            transition: transform 0.5s;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        body.light-mode .notification {
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-light);
            border: 1px solid rgba(0, 0, 0, 0.3);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification i {
            font-size: 1.5rem;
        }

        .notification.success i {
            color: #4CAF50;
        }

        .notification.error i {
            color: #f44336;
        }

        .notification.info i {
            color: #2196F3;
        }

        /* Admin Message */
        .admin-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(30px);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            color: white;
            z-index: 2000;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.3s;
        }

        body.light-mode .admin-message {
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-light);
            border: 1px solid rgba(0, 0, 0, 0.3);
        }

        .admin-message.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .admin-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .admin-message-header h3 {
            font-size: 1.5rem;
        }

        .close-message {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        body.light-mode .close-message {
            color: var(--text-light);
        }

        .admin-message-content img {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 10px;
            margin: 15px 0;
        }

        /* Admin Access Button */
        .admin-access-btn {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.5);
            z-index: 100;
            transition: transform 0.3s;
            display: none;
        }

        .admin-access-btn:hover {
            transform: scale(1.1);
        }

        /* Coin Transfer Confirmation Modal - UPDATED: 8 coins to author */
        .coin-confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2001;
            display: none;
        }

        .coin-confirm-box {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(30px);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
        }

        body.light-mode .coin-confirm-box {
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-light);
            border: 1px solid rgba(0, 0, 0, 0.3);
        }

        .coin-confirm-box h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: gold;
        }

        .coin-confirm-box p {
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .coin-transfer-details {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            border-left: 4px solid gold;
        }

        .coin-confirm-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .coin-confirm-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .coin-confirm-btn:hover {
            transform: translateY(-3px);
        }

        .coin-confirm-yes {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
        }

        .coin-confirm-no {
            background: linear-gradient(45deg, #f44336, #FF9800);
            color: white;
        }

        /* NEW: Enhanced Coin Transfer Success UI */
        .coin-transfer-success {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(139, 195, 74, 0.2));
            border: 2px solid rgba(76, 175, 80, 0.5);
            color: #4CAF50;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            display: none;
            animation: pulseSuccess 2s infinite;
            text-align: center;
        }

        .coin-transfer-success i {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: block;
        }

        .coin-transfer-success h4 {
            margin: 10px 0;
            font-size: 1.3rem;
        }

        @keyframes pulseSuccess {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }

        /* Like Confirmation Modal */
        .like-confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2001;
            display: none;
        }

        .like-confirm-box {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(30px);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
        }

        body.light-mode .like-confirm-box {
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-light);
            border: 1px solid rgba(0, 0, 0, 0.3);
        }

        .like-confirm-box h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #ff4757;
        }

        .like-confirm-box p {
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .like-confirm-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .like-confirm-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .like-confirm-btn:hover {
            transform: translateY(-3px);
        }

        .like-confirm-yes {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
        }

        .like-confirm-no {
            background: linear-gradient(45deg, #f44336, #FF9800);
            color: white;
        }

        /* Rating Confirmation Modal */
        .rating-confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2001;
            display: none;
        }

        .rating-confirm-box {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(30px);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
        }

        body.light-mode .rating-confirm-box {
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-light);
            border: 1px solid rgba(0, 0, 0, 0.3);
        }

        .rating-confirm-box h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: gold;
        }

        .rating-confirm-box p {
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .rating-preview {
            margin: 20px 0;
        }

        .rating-preview-stars {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .rating-preview-star {
            font-size: 2rem;
            color: rgba(255, 255, 255, 0.3);
            transition: color 0.3s;
        }

        .rating-preview-star.active {
            color: gold !important;
        }

        .rating-confirm-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .rating-confirm-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .rating-confirm-btn:hover {
            transform: translateY(-3px);
        }

        .rating-confirm-yes {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
        }

        .rating-confirm-no {
            background: linear-gradient(45deg, #f44336, #FF9800);
            color: white;
        }

        /* Loading Effect */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            display: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 1.2rem;
            font-weight: 500;
        }

        /* Admin Panel Container - UPDATED WITH MORE TABS */
        .admin-panel-container {
            display: none;
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-panel-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            color: white;
            border: 3px solid gold;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
        }

        body.light-mode .admin-panel-content {
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-light);
            border: 3px solid gold;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2);
        }

        .admin-panel-content h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: gold;
        }

        .admin-tabs {
            display: flex;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .admin-tab {
            padding: 15px 20px;
            cursor: pointer;
            color: white;
            font-weight: 500;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        body.light-mode .admin-tab {
            color: var(--text-light);
        }

        .admin-tab.active {
            border-bottom: 3px solid gold;
            color: gold !important;
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        /* Admin List Styles */
        .admin-list {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .admin-list-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
            transition: all 0.3s;
        }

        body.light-mode .admin-list-item {
            background: rgba(0, 0, 0, 0.05);
        }

        .admin-list-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: gold;
        }

        body.light-mode .admin-list-item:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .admin-list-item-info h4 {
            margin-bottom: 5px;
            color: var(--accent);
        }

        .admin-list-item-info p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
        }

        body.light-mode .admin-list-item-info p {
            color: rgba(0, 0, 0, 0.7);
        }

        .admin-list-item-actions {
            display: flex;
            gap: 10px;
        }

        .admin-action-btn {
            padding: 8px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .admin-action-btn:hover {
            transform: translateY(-2px);
        }

        .admin-delete-btn {
            background: linear-gradient(45deg, #f44336, #FF9800);
            color: white;
        }

        .admin-add-coin-btn {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
        }

        .admin-remove-coin-btn {
            background: linear-gradient(45deg, #FF9800, #FF5722);
            color: white;
        }

        /* Coin Management Form */
        .coin-management-form {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        body.light-mode .coin-management-form {
            background: rgba(0, 0, 0, 0.05);
        }

        .coin-management-form h3 {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: gold;
        }

        .coin-management-form .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .coin-management-form .form-row {
                flex-direction: column;
            }
        }

        .coin-management-form .form-group {
            flex: 1;
        }

        .coin-management-form label {
            display: block;
            margin-bottom: 8px;
            color: gold;
            font-weight: 500;
        }

        body.light-mode .coin-management-form label {
            color: #DAA520;
        }

        .user-select {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            outline: none;
        }

        body.light-mode .user-select {
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-light);
            border: 1px solid rgba(0, 0, 0, 0.2);
        }

        .coin-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .coin-actions {
                flex-direction: column;
            }
        }

        .coin-btn {
            flex: 1;
            padding: 15px;
            border-radius: 10px;
            border: none;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.3s;
        }

        .coin-btn:hover {
            transform: translateY(-3px);
        }

        .add-coins-btn {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
        }

        .remove-coins-btn {
            background: linear-gradient(45deg, #f44336, #FF9800);
        }

        .set-coins-btn {
            background: linear-gradient(45deg, #2196F3, #03A9F4);
        }

        /* Transaction History */
        .transaction-history {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
        }

        body.light-mode .transaction-history {
            background: rgba(0, 0, 0, 0.05);
        }

        .transaction-history h4 {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: gold;
        }

        body.light-mode .transaction-history h4 {
            color: #DAA520;
        }

        .transaction-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid;
        }

        body.light-mode .transaction-item {
            background: rgba(0, 0, 0, 0.05);
        }

        .transaction-item.added {
            border-left-color: #4CAF50;
        }

        .transaction-item.removed {
            border-left-color: #f44336;
        }

        .transaction-item.set {
            border-left-color: #2196F3;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .transaction-amount {
            font-weight: bold;
            font-size: 1.2rem;
        }

        .transaction-amount.added {
            color: #4CAF50;
        }

        .transaction-amount.removed {
            color: #f44336;
        }

        .transaction-amount.set {
            color: #2196F3;
        }

        .transaction-details {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        body.light-mode .transaction-details {
            color: rgba(0, 0, 0, 0.7);
        }

        /* Admin Stats */
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .admin-stat-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .admin-stat-item:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
        }

        .admin-stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: gold;
            margin-bottom: 5px;
        }

        .admin-stat-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        body.light-mode .admin-stat-label {
            color: rgba(0, 0, 0, 0.7);
        }

        /* Recent Activity */
        .recent-activity {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
        }

        body.light-mode .recent-activity {
            background: rgba(0, 0, 0, 0.05);
        }

        .activity-item {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        body.light-mode .activity-item {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(108, 99, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }

        .activity-content {
            flex: 1;
        }

        .activity-user {
            font-weight: 500;
        }

        .activity-time {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        body.light-mode .activity-time {
            color: rgba(0, 0, 0, 0.6);
        }

        /* Message Form - FIXED VERSION */
        .admin-message-form {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        body.light-mode .admin-message-form {
            background: rgba(0, 0, 0, 0.05);
        }

        .admin-message-form h3 {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: gold;
        }

        body.light-mode .admin-message-form h3 {
            color: #DAA520;
        }

        .admin-message-form label {
            display: block;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        body.light-mode .admin-message-form label {
            color: rgba(0, 0, 0, 0.8);
        }

        .message-image-upload {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 20px;
            transition: border-color 0.3s;
            background: rgba(255, 255, 255, 0.05);
        }

        body.light-mode .message-image-upload {
            border: 2px dashed rgba(0, 0, 0, 0.3);
            background: rgba(0, 0, 0, 0.05);
        }

        .message-image-upload:hover {
            border-color: var(--primary);
        }

        .message-image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        /* NEW: Admin Message Popup for Users - FIXED */
        .admin-message-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            color: #333;
            padding: 30px;
            border-radius: 20px;
            z-index: 9999;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            border: 3px solid var(--primary);
            transition: transform 0.3s;
        }

        .admin-message-popup.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .admin-message-popup img {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 10px;
            margin: 15px 0;
            display: block;
        }

        .close-msg-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            cursor: pointer;
            font-size: 24px;
            color: #666;
            background: none;
            border: none;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .close-msg-btn:hover {
            background: rgba(0, 0, 0, 0.1);
            color: #333;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .selection-container {
                flex-direction: column;
                align-items: center;
                gap: 30px;
            }
            
            .glass-card {
                width: 280px;
                height: 400px;
            }
            
            .auth-box {
                width: 90%;
                padding: 30px 20px;
            }
            
            .profile-stats {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .coin-confirm-buttons,
            .like-confirm-buttons,
            .rating-confirm-buttons {
                flex-direction: column;
            }
            
            .coin-confirm-box,
            .like-confirm-box,
            .rating-confirm-box {
                width: 95%;
                padding: 20px;
            }
            
            .admin-tabs {
                flex-direction: column;
            }
            
            .admin-tab {
                padding: 12px;
                text-align: center;
            }
            
            .admin-list-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .admin-list-item-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .admin-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .admin-message-popup {
                width: 95%;
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .admin-stats {
                grid-template-columns: 1fr;
            }
            
            .admin-list-item-actions {
                flex-wrap: wrap;
            }
            
            /* Extra small screens: even shorter titles */
            .item-title {
                max-width: 80px;
                font-size: 0.75rem !important;
            }
            
            /* Extra small screen rating adjustment */
            .novel-item .rating-section {
                gap: 3px;
            }
            
            .novel-item .stars {
                gap: 0;
            }
            
            .novel-item .star-btn {
                font-size: 0.55rem !important;
            }
            
            .novel-item .average-rating {
                font-size: 0.6rem !important;
            }
        }
    </style>
</head>
<body class="dark-mode">
    <!-- NEW: Coin Payment Success Banner -->
    <div class="coin-payment-success" id="coinPaymentSuccess">
        <div class="coin-payment-success-content">
            <i class="fas fa-check-circle"></i>
            <div>
                <h4>Payment Successful!</h4>
                <p>10 coins deducted. 8 coins transferred to author.</p>
            </div>
        </div>
    </div>

    <!-- NEW: Buy Coins Button -->
    <div class="buy-coins-btn" id="buyCoinsBtn">
        <a href="https://t.me/Zaiiaza" target="_blank">
            <i class="fas fa-shopping-cart"></i> Coin 
        </a>
    </div>

    <!-- Bubbles Animation -->
    <div class="bubbles-container" id="bubbles"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>

    <!-- 'VERSE Logo Animation -->
    <div class="verse-logo" id="verseLogo">
        <div class="verse-text">'VERSE</div>
    </div>

    <!-- Theme Toggle -->
    <div class="theme-toggle">
        <button class="theme-btn" id="themeToggle">
            <i class="fas fa-moon"></i>
        </button>
    </div>

    <!-- Auth Container -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-header">
                <h2>Welcome to 'VERSE Realm</h2>
                <p>Create and share your poetry & stories</p>
            </div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" data-tab="login">Login</div>
                <div class="auth-tab" data-tab="signup">Sign Up</div>
            </div>
            
            <form class="auth-form active" id="loginForm">
                <div class="form-group">
                    <input type="email" id="loginEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="loginPassword" placeholder="Password" required>
                </div>
                <button type="submit" class="auth-btn">Login</button>
            </form>
            
            <form class="auth-form" id="signupForm">
                <div class="form-group">
                    <input type="text" id="signupName" placeholder="Full Name" required>
                </div>
                <div class="form-group">
                    <input type="email" id="signupEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="signupPassword" placeholder="Password" required>
                </div>
                <div class="form-group">
                    <input type="text" id="signupNickname" placeholder="Nickname (Display Name)" required>
                </div>
                <button type="submit" class="auth-btn">Sign Up</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <div class="header">
            <div class="user-section">
                <div class="user-info" id="userProfileBtn">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <h3 id="userName">User</h3>
                        <p id="userEmail">user@example.com</p>
                    </div>
                </div>
                <div class="coin-display">
                    <i class="fas fa-coins"></i>
                    <span id="userCoins">150</span> Coins
                </div>
            </div>
            
            <div class="user-actions">
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
        
        <div class="selection-container">
            <div class="selection-card">
                <div class="glass-card"></div>
                <div class="card-content" id="poemSelection">
                    <h3>Poems</h3>
                    <p>Write and share your beautiful poetry</p>
                    <p><i class="fas fa-arrow-right"></i> Click to explore</p>
                </div>
            </div>
            
            <div class="selection-card">
                <div class="glass-card"></div>
                <div class="card-content" id="novelSelection">
                    <h3>Novels</h3>
                    <p>Create and read captivating stories</p>
                    <p><i class="fas fa-arrow-right"></i> Click to explore</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Poem List -->
    <div class="poem-list-container" id="poemListContainer">
        <button class="back-btn" id="backFromPoemList">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </button>
        
        <div class="search-bar">
            <input type="text" id="poemSearch" placeholder="Search poems by title or author...">
            <i class="fas fa-search"></i>
        </div>
        
        <div class="poems-grid" id="poemsGrid">
            <!-- Poems will be loaded here -->
        </div>
    </div>

    <!-- Novel List -->
    <div class="novel-list-container" id="novelListContainer">
        <button class="back-btn" id="backFromNovelList">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </button>
        
        <div class="search-bar">
            <input type="text" id="novelSearch" placeholder="Search novels by title or author...">
            <i class="fas fa-search"></i>
        </div>
        
        <div class="novels-grid" id="novelsGrid">
            <!-- Novels will be loaded here -->
        </div>
    </div>

    <!-- Poem Detail -->
    <div class="poem-detail-container" id="poemDetailContainer">
        <button class="back-btn" id="backFromPoemDetail">
            <i class="fas fa-arrow-left"></i> Back to Poems
        </button>
        
        <div class="detail-header">
            <h1 id="poemDetailTitle">Poem Title</h1>
            <p id="poemDetailAuthor">By Author</p>
            
            <!-- NEW: Category and Date Information -->
            <div class="detail-meta-info">
                <div class="detail-category">
                    <i class="fas fa-tag"></i>
                    <span id="poemDetailCategory">Uncategorized</span>
                </div>
                <div class="detail-date">
                    <i class="fas fa-calendar"></i>
                    <span id="poemDetailDate">Date</span>
                </div>
            </div>
            
            <div class="author-section" id="poemAuthorProfileBtn">
                <div class="author-avatar" id="poemAuthorAvatar">A</div>
                <div>
                    <div class="author-name" id="poemAuthorName">Author Name</div>
                    <div class="author-email" id="poemAuthorEmail">author@example.com</div>
                </div>
            </div>
            
            <div class="like-section">
                <button class="like-btn" id="poemDetailLikeBtn">
                    <i class="fas fa-heart"></i>
                </button>
                <span class="like-count" id="poemDetailLikeCount">0</span>
            </div>
        </div>
        
        <img id="poemDetailImage" src="" alt="Poem Image" class="detail-image">
        
        <div class="detail-content" id="poemDetailContent">
            <!-- Poem content will be loaded here -->
        </div>
    </div>

    <!-- Novel Detail -->
    <div class="novel-detail-container" id="novelDetailContainer">
        <button class="back-btn" id="backFromNovelDetail">
            <i class="fas fa-arrow-left"></i> Back to Novels
        </button>
        
        <div class="detail-header">
            <h1 id="novelDetailTitle">Novel Title</h1>
            <p id="novelDetailAuthor">By Author</p>
            
            <!-- NEW: Category and Date Information -->
            <div class="detail-meta-info">
                <div class="detail-category">
                    <i class="fas fa-tag"></i>
                    <span id="novelDetailCategory">Uncategorized</span>
                </div>
                <div class="detail-date">
                    <i class="fas fa-calendar"></i>
                    <span id="novelDetailDate">Date</span>
                </div>
            </div>
            
            <div class="author-section" id="novelAuthorProfileBtn">
                <div class="author-avatar" id="novelAuthorAvatar">A</div>
                <div>
                    <div class="author-name" id="novelAuthorName">Author Name</div>
                    <div class="author-email" id="novelAuthorEmail">author@example.com</div>
                </div>
            </div>
            
            <div class="like-section">
                <button class="like-btn" id="novelDetailLikeBtn">
                    <i class="fas fa-heart"></i>
                </button>
                <span class="like-count" id="novelDetailLikeCount">0</span>
            </div>
            
            <div class="rating-section">
                <div class="stars" id="novelStars">
                    <button class="star-btn" data-rating="1"><i class="fas fa-star"></i></button>
                    <button class="star-btn" data-rating="2"><i class="fas fa-star"></i></button>
                    <button class="star-btn" data-rating="3"><i class="fas fa-star"></i></button>
                    <button class="star-btn" data-rating="4"><i class="fas fa-star"></i></button>
                    <button class="star-btn" data-rating="5"><i class="fas fa-star"></i></button>
                </div>
                <div class="average-rating">
                    <span>Average:</span>
                    <span id="novelAverageRating">0.0</span>
                </div>
                <div class="rating-count">
                    (<span id="novelRatingCount">0</span> ratings)
                </div>
            </div>
            
            <!-- UPDATED: 8 coins to author, 2 coins platform fee -->
            <div class="coin-cost-indicator">
                <i class="fas fa-coins"></i>
                <span>Reading costs 10 coins (8 to author, 2 platform fee)</span>
            </div>
        </div>
        
        <img id="novelDetailImage" src="" alt="Novel Image" class="detail-image">
        
        <div class="detail-content" id="novelDetailContent">
            <!-- Novel content will be loaded here -->
        </div>
    </div>

    <!-- Upload Container -->
    <div class="upload-container" id="uploadContainer">
        <button class="back-btn" id="backFromUpload">
            <i class="fas fa-arrow-left"></i> Back
        </button>
        
        <div class="upload-form">
            <div class="upload-header">
                <div class="user-avatar" id="uploadUserAvatar">U</div>
                <div>
                    <h3 id="uploadUserName">User</h3>
                    <p>Create a new <span id="uploadType">Poem</span></p>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <input type="text" id="uploadTitle" placeholder="Title" required>
                </div>
                <div class="form-group">
                    <input type="text" id="uploadCategory" placeholder="Category (Optional)">
                </div>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Click to upload image or drag and drop</p>
                <p>PNG, JPG, GIF up to 5MB</p>
                <input type="file" id="imageUpload" accept="image/*" hidden>
                <img id="imagePreview" class="image-preview">
                <!-- NEW: Upload progress indicator -->
                <div class="upload-progress" id="uploadProgress">
                    <div class="upload-progress-bar" id="uploadProgressBar"></div>
                </div>
            </div>
            
            <div class="form-group">
                <textarea id="uploadContent" placeholder="Write your content here..." required></textarea>
            </div>
            
            <button class="upload-btn" id="submitUpload">
                <i class="fas fa-upload"></i> Upload <span id="uploadTypeText">Poem</span>
                <span id="coinCost">(Cost: 10 Coins)</span>
            </button>
            
            <div class="coin-cost">
                <i class="fas fa-coins"></i> You have <span id="currentCoins">150</span> coins remaining
            </div>
        </div>
    </div>

    <!-- Profile Container -->
    <div class="profile-container" id="profileContainer">
        <button class="back-btn" id="backFromProfile">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </button>
        
        <div class="profile-card">
            <div class="profile-header">
                <div class="profile-avatar" id="profileAvatar">U</div>
                <div class="profile-info">
                    <h3 id="profileName">User Name</h3>
                    <p id="profileEmail">user@example.com</p>
                    <p>Member since: <span id="memberSince">2023</span></p>
                    <button class="logout-btn" id="logoutBtnProfile" style="margin-top: 10px;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
            
            <div class="profile-stats">
                <div class="stat-item">
                    <div class="stat-value" id="statPoems">0</div>
                    <div>Poems</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statNovels">0</div>
                    <div>Novels</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statCoins">150</div>
                    <div>Coins</div>
                </div>
            </div>
            
            <div class="my-poems">
                <h4>My Poems</h4>
                <div class="my-items-grid" id="myPoemsGrid">
                    <!-- User's poems will be loaded here -->
                </div>
            </div>
            
            <div class="my-novels">
                <h4>My Novels</h4>
                <div class="my-items-grid" id="myNovelsGrid">
                    <!-- User's novels will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Container -->
    <div class="user-profile-container" id="userProfileContainer">
        <button class="back-btn" id="backFromUserProfile">
            <i class="fas fa-arrow-left"></i> Back
        </button>
        
        <div class="user-profile-content" id="userProfileContent">
            <!-- User profile content will be loaded here -->
        </div>
    </div>

    <!-- Admin Panel Container -->
    <div class="admin-panel-container" id="adminPanelContainer">
        <button class="back-btn" id="backFromAdminPanel">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </button>
        
        <div class="admin-panel-content">
            <h2><i class="fas fa-crown"></i> Admin Panel</h2>
            
            <div class="admin-tabs">
                <div class="admin-tab active" data-tab="users">Users</div>
                <div class="admin-tab" data-tab="poems">Poems</div>
                <div class="admin-tab" data-tab="novels">Novels</div>
                <div class="admin-tab" data-tab="coinManagement">Coin Management</div>
                <div class="admin-tab" data-tab="messages">Send Message</div>
                <div class="admin-tab" data-tab="statistics">Statistics</div>
            </div>
            
            <!-- Users Tab -->
            <div class="admin-tab-content active" id="usersTab">
                <div class="search-bar">
                    <input type="text" id="adminUserSearch" placeholder="Search users...">
                    <i class="fas fa-search"></i>
                </div>
                <div class="admin-list" id="adminUsersList">
                    <!-- Users will be loaded here -->
                </div>
            </div>
            
            <!-- Poems Tab -->
            <div class="admin-tab-content" id="poemsTab">
                <div class="search-bar">
                    <input type="text" id="adminPoemSearch" placeholder="Search poems...">
                    <i class="fas fa-search"></i>
                </div>
                <div class="admin-list" id="adminPoemsList">
                    <!-- Poems will be loaded here -->
                </div>
            </div>
            
            <!-- Novels Tab -->
            <div class="admin-tab-content" id="novelsTab">
                <div class="search-bar">
                    <input type="text" id="adminNovelSearch" placeholder="Search novels...">
                    <i class="fas fa-search"></i>
                </div>
                <div class="admin-list" id="adminNovelsList">
                    <!-- Novels will be loaded here -->
                </div>
            </div>
            
            <!-- Coin Management Tab -->
            <div class="admin-tab-content" id="coinManagementTab">
                <div class="coin-management-form">
                    <h3><i class="fas fa-coins"></i> Coin Management</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="coinUserSelect">Select User</label>
                            <select id="coinUserSelect" class="user-select">
                                <option value="">Select a user...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="coinAmount">Amount</label>
                            <input type="number" id="coinAmount" placeholder="Enter coin amount" min="1" max="100000">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="coinReason">Reason (Optional)</label>
                        <input type="text" id="coinReason" placeholder="Reason for coin adjustment">
                    </div>
                    
                    <div class="coin-actions">
                        <button class="coin-btn add-coins-btn" id="addCoinsBtn">
                            <i class="fas fa-plus-circle"></i> Add Coins
                        </button>
                        <button class="coin-btn remove-coins-btn" id="removeCoinsBtn">
                            <i class="fas fa-minus-circle"></i> Remove Coins
                        </button>
                        <button class="coin-btn set-coins-btn" id="setCoinsBtn">
                            <i class="fas fa-equals"></i> Set Coins
                        </button>
                    </div>
                </div>
                
                <div class="transaction-history">
                    <h4><i class="fas fa-history"></i> Recent Transactions</h4>
                    <div class="admin-list" id="transactionsList">
                        <!-- Transactions will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Messages Tab - FIXED VERSION -->
            <div class="admin-tab-content" id="messagesTab">
                <div class="admin-message-form">
                    <h3><i class="fas fa-paper-plane"></i> Send Admin Message</h3>
                    
                    <div class="form-group">
                        <label for="messageRecipient">Select Recipient</label>
                        <select id="messageRecipient" class="user-select">
                            <option value="all">All Users (Broadcast)</option>
                            <!-- Users will be populated here -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="adminMessageTitle">Message Title</label>
                        <input type="text" id="adminMessageTitle" placeholder="Enter message title..." required>
                    </div>
                    
                    <div class="form-group">
                        <label for="adminMessageText">Message Content</label>
                        <textarea id="adminMessageText" rows="4" placeholder="Enter message content..." required></textarea>
                    </div>
                    
                    <div class="message-image-upload" id="messageImageUploadArea">
                        <i class="fas fa-image"></i>
                        <p>Click to upload image (Optional)</p>
                        <input type="file" id="adminMessageImage" accept="image/*" hidden>
                        <img id="messageImagePreview" class="message-image-preview">
                    </div>
                    
                    <button class="auth-btn" id="sendAdminMessageBtn">
                        <i class="fas fa-paper-plane"></i> Send Message
                    </button>
                </div>
            </div>
            
            <!-- Statistics Tab -->
            <div class="admin-tab-content" id="statisticsTab">
                <div class="admin-stats">
                    <div class="admin-stat-item">
                        <div class="admin-stat-value" id="adminTotalUsers">0</div>
                        <div class="admin-stat-label">Total Users</div>
                    </div>
                    <div class="admin-stat-item">
                        <div class="admin-stat-value" id="adminTotalPoems">0</div>
                        <div class="admin-stat-label">Total Poems</div>
                    </div>
                    <div class="admin-stat-item">
                        <div class="admin-stat-value" id="adminTotalNovels">0</div>
                        <div class="admin-stat-label">Total Novels</div>
                    </div>
                    <div class="admin-stat-item">
                        <div class="admin-stat-value" id="adminTotalCoins">0</div>
                        <div class="admin-stat-label">Total Coins</div>
                    </div>
                </div>
                
                <div class="recent-activity">
                    <h4><i class="fas fa-chart-line"></i> Recent Activity</h4>
                    <div class="admin-list" id="activityList">
                        <!-- Activity will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Coin Transfer Confirmation Modal - UPDATED: 8 coins to author -->
    <div class="coin-confirm-modal" id="coinConfirmModal">
        <div class="coin-confirm-box">
            <h3><i class="fas fa-coins"></i> Confirm Coin Transfer</h3>
            <p>Reading this novel will deduct <strong>10 coins</strong> from you. <strong>8 coins</strong> will be transferred to the author and <strong>2 coins</strong> are platform fee.</p>
            
            <div class="coin-transfer-details">
                <div><strong>From:</strong> <span id="coinTransferFrom">You</span></div>
                <div><strong>To Author:</strong> <span id="coinTransferTo">Author</span></div>
                <div><strong>Amount to Author:</strong> <span style="color: gold;">8 coins</span></div>
                <div><strong>Platform Fee:</strong> <span style="color: #36D1DC;">2 coins</span></div>
                <div><strong>Total Deducted:</strong> <span style="color: #FF6584;">10 coins</span></div>
                <div><strong>Your balance:</strong> <span id="coinTransferBalance">150</span> coins</div>
            </div>
            
            <p>Do you want to proceed?</p>
            
            <div class="coin-confirm-buttons">
                <button class="coin-confirm-btn coin-confirm-yes" id="coinConfirmYes">
                    Yes, transfer coins & read
                </button>
                <button class="coin-confirm-btn coin-confirm-no" id="coinConfirmNo">
                    No, cancel
                </button>
            </div>
            
            <div class="coin-transfer-success" id="coinTransferSuccess">
                <i class="fas fa-check-circle"></i>
                <h4>Payment Successful!</h4>
                <p>10 coins deducted. 8 coins transferred to author successfully!</p>
            </div>
        </div>
    </div>

    <!-- Like Confirmation Modal -->
    <div class="like-confirm-modal" id="likeConfirmModal">
        <div class="like-confirm-box">
            <h3><i class="fas fa-heart"></i> Confirm Like</h3>
            <p id="likeConfirmMessage">Are you like this Poem?</p>
            
            <div class="like-confirm-buttons">
                <button class="like-confirm-btn like-confirm-yes" id="likeConfirmYes">
                    Yes, I like it!
                </button>
                <button class="like-confirm-btn like-confirm-no" id="likeConfirmNo">
                    No, cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Rating Confirmation Modal -->
    <div class="rating-confirm-modal" id="ratingConfirmModal">
        <div class="rating-confirm-box">
            <h3><i class="fas fa-star"></i> Confirm Rating</h3>
            <p>Are you like this Novel?</p>
            
            <div class="rating-preview">
                <div class="rating-preview-stars" id="ratingPreviewStars">
                    <i class="fas fa-star rating-preview-star" data-rating="1"></i>
                    <i class="fas fa-star rating-preview-star" data-rating="2"></i>
                    <i class="fas fa-star rating-preview-star" data-rating="3"></i>
                    <i class="fas fa-star rating-preview-star" data-rating="4"></i>
                    <i class="fas fa-star rating-preview-star" data-rating="5"></i>
                </div>
                <p>Your rating: <span id="ratingPreviewValue">0</span> stars</p>
            </div>
            
            <div class="rating-confirm-buttons">
                <button class="rating-confirm-btn rating-confirm-yes" id="ratingConfirmYes">
                    Yes, rate it!
                </button>
                <button class="rating-confirm-btn rating-confirm-no" id="ratingConfirmNo">
                    No, cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Floating Add Button - FIXED -->
    <div class="floating-add-btn" id="floatingAddBtn">
        <i class="fas fa-plus"></i>
    </div>

    <!-- Admin Access Button -->
    <div class="admin-access-btn" id="adminAccessBtn">
        <i class="fas fa-crown"></i>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-info-circle"></i>
        <div class="notification-content">Notification message</div>
    </div>

    <!-- Admin Message Popup (for users) -->
    <div class="admin-message-popup" id="adminMessagePopup">
        <button class="close-msg-btn" id="closeMsgBtn">&times;</button>
        <h3 id="popupTitle" style="color: var(--primary); margin-bottom: 15px;"></h3>
        <img id="popupImage" src="" style="display:none; width:100%; border-radius:10px; margin:10px 0;">
        <p id="popupText" style="margin-top: 10px; line-height: 1.6; white-space: pre-line;"></p>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
        // FIXED Firebase Configuration
         // Firebase Configuration
       const firebaseConfig = {
  apiKey: "AIzaSyARguxf3-DdOCE9tGLfPLcGIWxRMmHZdns",
  authDomain: "control-my-v1.firebaseapp.com",
  databaseURL: "https://control-my-v1-default-rtdb.firebaseio.com",
  projectId: "control-my-v1",
  storageBucket: "control-my-v1.firebasestorage.app",
  messagingSenderId: "780907108895",
  appId: "1:780907108895:web:2e6455329d329fcf38932a",
  measurementId: "G-PWGS7VL1RV"
};
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // DOM Elements
        const verseLogo = document.getElementById('verseLogo');
        const authContainer = document.getElementById('authContainer');
        const dashboard = document.getElementById('dashboard');
        const themeToggle = document.getElementById('themeToggle');
        const poemSelection = document.getElementById('poemSelection');
        const novelSelection = document.getElementById('novelSelection');
        const poemListContainer = document.getElementById('poemListContainer');
        const novelListContainer = document.getElementById('novelListContainer');
        const poemDetailContainer = document.getElementById('poemDetailContainer');
        const novelDetailContainer = document.getElementById('novelDetailContainer');
        const uploadContainer = document.getElementById('uploadContainer');
        const profileContainer = document.getElementById('profileContainer');
        const userProfileContainer = document.getElementById('userProfileContainer');
        const adminPanelContainer = document.getElementById('adminPanelContainer');
        const adminAccessBtn = document.getElementById('adminAccessBtn');
        const floatingAddBtn = document.getElementById('floatingAddBtn');
        const notification = document.getElementById('notification');
        const adminMessagePopup = document.getElementById('adminMessagePopup');
        const closeMsgBtn = document.getElementById('closeMsgBtn');
        const popupTitle = document.getElementById('popupTitle');
        const popupImage = document.getElementById('popupImage');
        const popupText = document.getElementById('popupText');
        const coinConfirmModal = document.getElementById('coinConfirmModal');
        const coinConfirmYes = document.getElementById('coinConfirmYes');
        const coinConfirmNo = document.getElementById('coinConfirmNo');
        const coinTransferSuccess = document.getElementById('coinTransferSuccess');
        const coinPaymentSuccess = document.getElementById('coinPaymentSuccess');
        const likeConfirmModal = document.getElementById('likeConfirmModal');
        const likeConfirmYes = document.getElementById('likeConfirmYes');
        const likeConfirmNo = document.getElementById('likeConfirmNo');
        const likeConfirmMessage = document.getElementById('likeConfirmMessage');
        const ratingConfirmModal = document.getElementById('ratingConfirmModal');
        const ratingConfirmYes = document.getElementById('ratingConfirmYes');
        const ratingConfirmNo = document.getElementById('ratingConfirmNo');
        const ratingPreviewStars = document.getElementById('ratingPreviewStars');
        const ratingPreviewValue = document.getElementById('ratingPreviewValue');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        const messageRecipient = document.getElementById('messageRecipient');
        const adminMessageTitle = document.getElementById('adminMessageTitle');
        const adminMessageText = document.getElementById('adminMessageText');
        const adminMessageImage = document.getElementById('adminMessageImage');
        const messageImageUploadArea = document.getElementById('messageImageUploadArea');
        const messageImagePreview = document.getElementById('messageImagePreview');
        const sendAdminMessageBtn = document.getElementById('sendAdminMessageBtn');
        const buyCoinsBtn = document.getElementById('buyCoinsBtn');

        // State variables
        let currentUser = null;
        let isAdmin = false;
        let currentUploadType = 'poem';
        let allPoems = [];
        let allNovels = [];
        let userPoems = [];
        let userNovels = [];
        let isEditing = false;
        let editingContentId = null;
        let likedPoems = new Set();
        let likedNovels = new Set();
        let ratedNovels = new Map();
        let userReads = new Set();
        let viewingUserId = null;
        let pendingNovelRead = null;
        let pendingLikeAction = null;
        let pendingRatingAction = null;
        let adminUsers = [];
        let adminPoems = [];
        let adminNovels = [];
        let adminTransactions = [];
        let currentMessageId = null; // For tracking which message is being displayed

        // Admin emails configuration
        const adminEmails = [
            "admin@verse.com",
            "zinthu333777@gmail.com",
            "zinthusoe217@gmail.com"
        ];

        // Initialize bubbles
        function initBubbles() {
            const bubblesContainer = document.getElementById('bubbles');
            bubblesContainer.innerHTML = '';
            for (let i = 0; i < 50; i++) {
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                
                const size = Math.random() * 60 + 20;
                bubble.style.width = `${size}px`;
                bubble.style.height = `${size}px`;
                bubble.style.left = `${Math.random() * 100}%`;
                bubble.style.animationDelay = `${Math.random() * 15}s`;
                bubble.style.animationDuration = `${Math.random() * 10 + 15}s`;
                bubble.style.opacity = Math.random() * 0.5 + 0.1;
                
                const colors = [
                    'rgba(108, 99, 255, 0.3)',
                    'rgba(255, 101, 132, 0.3)',
                    'rgba(54, 209, 220, 0.3)',
                    'rgba(255, 255, 255, 0.2)'
                ];
                bubble.style.background = colors[Math.floor(Math.random() * colors.length)];
                
                bubblesContainer.appendChild(bubble);
            }
        }

        // Show loading
        function showLoading(message = "Loading...") {
            loadingText.textContent = message;
            loadingOverlay.style.display = 'flex';
        }

        // Hide loading
        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const icon = notification.querySelector('i');
            const content = notification.querySelector('.notification-content');
            
            icon.className = 'fas ' + (
                type === 'success' ? 'fa-check-circle' :
                type === 'error' ? 'fa-exclamation-circle' :
                'fa-info-circle'
            );
            
            content.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Show coin payment success banner
        function showCoinPaymentSuccess() {
            coinPaymentSuccess.style.display = 'block';
            setTimeout(() => {
                coinPaymentSuccess.style.display = 'none';
            }, 3500);
        }

        // Show/hide sections
        function showSection(section) {
            const sections = [
                dashboard, poemListContainer, novelListContainer,
                poemDetailContainer, novelDetailContainer,
                uploadContainer, profileContainer, userProfileContainer,
                adminPanelContainer
            ];
            
            sections.forEach(sec => {
                if (sec) sec.style.display = 'none';
            });
            
            if (section) {
                section.style.display = 'block';
                
                // FIXED: Floating add button visibility
                if (section === dashboard || section === poemListContainer || 
                    section === novelListContainer || section === profileContainer) {
                    floatingAddBtn.style.display = 'flex';
                } else {
                    floatingAddBtn.style.display = 'none';
                }
                
                if (isAdmin && (section === dashboard || section === poemListContainer || 
                    section === novelListContainer || section === profileContainer || section === adminPanelContainer)) {
                    adminAccessBtn.style.display = 'flex';
                } else {
                    adminAccessBtn.style.display = 'none';
                }
            }
        }

        // Logout function
        function logoutUser() {
            if (confirm("Are you sure you want to logout?")) {
                auth.signOut()
                    .then(() => {
                        showNotification("Logged out successfully", "success");
                        currentUser = null;
                        isAdmin = false;
                        
                        authContainer.style.display = 'flex';
                        showSection(null);
                        adminAccessBtn.style.display = 'none';
                        
                        document.getElementById('loginEmail').value = '';
                        document.getElementById('loginPassword').value = '';
                        
                        verseLogo.style.display = 'flex';
                        setTimeout(() => {
                            verseLogo.style.display = 'none';
                            authContainer.style.display = 'flex';
                        }, 2000);
                    })
                    .catch((error) => {
                        console.error("Logout error:", error);
                        showNotification("Logout failed: " + error.message, "error");
                    });
            }
        }

        // Update user info in UI
        function updateUserInfo(user) {
            const userName = document.getElementById('userName');
            const userEmail = document.getElementById('userEmail');
            const userAvatar = document.getElementById('userAvatar');
            const uploadUserName = document.getElementById('uploadUserName');
            const uploadUserAvatar = document.getElementById('uploadUserAvatar');
            const profileName = document.getElementById('profileName');
            const profileEmail = document.getElementById('profileEmail');
            const profileAvatar = document.getElementById('profileAvatar');
            
            if (user) {
                const displayName = user.displayName || user.email.split('@')[0];
                const firstLetter = displayName.charAt(0).toUpperCase();
                
                if (userName) userName.textContent = displayName;
                if (userEmail) userEmail.textContent = user.email;
                if (userAvatar) {
                    userAvatar.textContent = firstLetter;
                    userAvatar.style.background = `linear-gradient(45deg, var(--primary), var(--secondary))`;
                }
                
                if (uploadUserName) uploadUserName.textContent = displayName;
                if (uploadUserAvatar) {
                    uploadUserAvatar.textContent = firstLetter;
                    uploadUserAvatar.style.background = `linear-gradient(45deg, var(--primary), var(--secondary))`;
                }
                
                if (profileName) profileName.textContent = displayName;
                if (profileEmail) profileEmail.textContent = user.email;
                if (profileAvatar) {
                    profileAvatar.textContent = firstLetter;
                    profileAvatar.style.background = `linear-gradient(45deg, var(--primary), var(--secondary))`;
                }
                
                const memberSince = document.getElementById('memberSince');
                if (memberSince) {
                    memberSince.textContent = new Date(user.metadata.creationTime).getFullYear();
                }
                
                updateUserCoins();
            }
        }

        // Update user coins
        function updateUserCoins() {
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        const coins = userData.coins || 150;
                        
                        const coinDisplays = [
                            document.getElementById('userCoins'),
                            document.getElementById('currentCoins'),
                            document.getElementById('statCoins')
                        ];
                        
                        coinDisplays.forEach(display => {
                            if (display) display.textContent = coins;
                        });
                    }
                })
                .catch(error => {
                    console.error("Error getting user coins:", error);
                });
        }

        // Check if user is admin
        function checkAdminStatus(user) {
            if (!user) return false;
            
            const userEmail = user.email;
            const isAdminUser = adminEmails.includes(userEmail);
            
            db.collection('users').doc(user.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        // Update admin status if needed
                        if (isAdminUser && !userData.isAdmin) {
                            db.collection('users').doc(user.uid).update({
                                isAdmin: true,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                        
                        isAdmin = (isAdminUser || userData.isAdmin) || false;
                        
                        if (isAdmin) {
                            adminAccessBtn.style.display = 'flex';
                            showNotification("Admin privileges enabled", "success");
                        } else {
                            adminAccessBtn.style.display = 'none';
                        }
                    } else if (isAdminUser) {
                        // Create user document if doesn't exist
                        db.collection('users').doc(user.uid).set({
                            email: userEmail,
                            name: user.displayName || userEmail.split('@')[0],
                            nickname: user.displayName || userEmail.split('@')[0],
                            isAdmin: true,
                            coins: 10000,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }).then(() => {
                            isAdmin = true;
                            adminAccessBtn.style.display = 'flex';
                            showNotification("Admin privileges enabled", "success");
                        });
                    }
                })
                .catch(error => {
                    console.error("Error checking admin status:", error);
                });
        }

        // Load user likes and ratings
        function loadUserLikesAndRatings() {
            if (!currentUser) return;
            
            likedPoems.clear();
            likedNovels.clear();
            ratedNovels.clear();
            userReads.clear();
            
            // Load liked poems
            db.collectionGroup('likes').where('userId', '==', currentUser.uid).where('type', '==', 'poem').get()
                .then(querySnapshot => {
                    querySnapshot.forEach(doc => {
                        likedPoems.add(doc.data().contentId);
                    });
                    loadPoems();
                });
            
            // Load liked novels
            db.collectionGroup('likes').where('userId', '==', currentUser.uid).where('type', '==', 'novel').get()
                .then(querySnapshot => {
                    querySnapshot.forEach(doc => {
                        likedNovels.add(doc.data().contentId);
                    });
                });
            
            // Load novel ratings
            db.collectionGroup('ratings').where('userId', '==', currentUser.uid).get()
                .then(querySnapshot => {
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        ratedNovels.set(data.novelId, data.rating);
                    });
                });
            
            // Load user reads
            db.collection('reads').where('userId', '==', currentUser.uid).get()
                .then(querySnapshot => {
                    querySnapshot.forEach(doc => {
                        userReads.add(doc.data().novelId);
                    });
                });
        }

        // Show like confirmation
        function showLikeConfirmation(contentId, type, title) {
            pendingLikeAction = { contentId, type };
            
            // Update modal content
            likeConfirmMessage.textContent = `Are you like this ${type === 'poem' ? 'Poem' : 'Novel'}?`;
            
            // Show modal
            likeConfirmModal.style.display = 'flex';
        }

        // Toggle like for poem or novel (after confirmation)
        async function toggleLike(contentId, type) {
            if (!currentUser) {
                showNotification("Please login to like content", "error");
                return;
            }
            
            const collectionName = type === 'poem' ? 'poems' : 'novels';
            const likeRef = db.collection(collectionName).doc(contentId).collection('likes').doc(currentUser.uid);
            
            try {
                const likeDoc = await likeRef.get();
                
                if (likeDoc.exists) {
                    // Unlike
                    await likeRef.delete();
                    
                    // Update like count
                    await db.collection(collectionName).doc(contentId).update({
                        likeCount: firebase.firestore.FieldValue.increment(-1)
                    });
                    
                    if (type === 'poem') {
                        likedPoems.delete(contentId);
                    } else {
                        likedNovels.delete(contentId);
                    }
                    
                    showNotification("Like removed", "success");
                } else {
                    // Like
                    await likeRef.set({
                        userId: currentUser.uid,
                        contentId: contentId,
                        type: type,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update like count
                    await db.collection(collectionName).doc(contentId).update({
                        likeCount: firebase.firestore.FieldValue.increment(1)
                    });
                    
                    if (type === 'poem') {
                        likedPoems.add(contentId);
                    } else {
                        likedNovels.add(contentId);
                    }
                    
                    showNotification("Liked!", "success");
                }
                
                // Refresh the view
                if (type === 'poem') {
                    loadPoems();
                    if (poemDetailContainer.style.display === 'block') {
                        const currentPoemId = document.getElementById('poemDetailTitle').dataset.id;
                        if (currentPoemId === contentId) {
                            showPoemDetail(allPoems.find(p => p.id === contentId));
                        }
                    }
                } else {
                    loadNovels();
                    if (novelDetailContainer.style.display === 'block') {
                        const currentNovelId = document.getElementById('novelDetailTitle').dataset.id;
                        if (currentNovelId === contentId) {
                            showNovelDetail(allNovels.find(n => n.id === contentId));
                        }
                    }
                }
                
            } catch (error) {
                console.error("Error toggling like:", error);
                showNotification("Error updating like", "error");
            }
        }

        // Show rating confirmation
        function showRatingConfirmation(novelId, rating) {
            pendingRatingAction = { novelId, rating };
            
            // Update preview stars
            const stars = ratingPreviewStars.querySelectorAll('.rating-preview-star');
            stars.forEach(star => {
                const starRating = parseInt(star.getAttribute('data-rating'));
                if (starRating <= rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
            
            ratingPreviewValue.textContent = rating;
            
            // Show modal
            ratingConfirmModal.style.display = 'flex';
        }

        // Rate a novel (after confirmation)
        async function rateNovel(novelId, rating) {
            if (!currentUser) {
                showNotification("Please login to rate novels", "error");
                return;
            }
            
            const ratingRef = db.collection('novels').doc(novelId).collection('ratings').doc(currentUser.uid);
            
            try {
                const ratingDoc = await ratingRef.get();
                const novelRef = db.collection('novels').doc(novelId);
                
                if (ratingDoc.exists) {
                    // Update existing rating
                    const oldRating = ratingDoc.data().rating;
                    await ratingRef.update({
                        rating: rating,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update novel's average rating
                    const novelDoc = await novelRef.get();
                    const novelData = novelDoc.data();
                    const currentTotal = (novelData.averageRating || 0) * (novelData.ratingCount || 0);
                    const newTotal = currentTotal - oldRating + rating;
                    const newAverage = newTotal / (novelData.ratingCount || 1);
                    
                    await novelRef.update({
                        averageRating: newAverage,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showNotification(`Rating updated to ${rating} stars`, "success");
                } else {
                    // Add new rating
                    await ratingRef.set({
                        userId: currentUser.uid,
                        novelId: novelId,
                        rating: rating,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update novel's average rating and count
                    const novelDoc = await novelRef.get();
                    const novelData = novelDoc.data();
                    const currentTotal = (novelData.averageRating || 0) * (novelData.ratingCount || 0);
                    const newTotal = currentTotal + rating;
                    const newCount = (novelData.ratingCount || 0) + 1;
                    const newAverage = newTotal / newCount;
                    
                    await novelRef.update({
                        averageRating: newAverage,
                        ratingCount: newCount,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showNotification(`Rated ${rating} stars`, "success");
                }
                
                ratedNovels.set(novelId, rating);
                
                // Refresh the view
                if (novelDetailContainer.style.display === 'block') {
                    const currentNovelId = document.getElementById('novelDetailTitle').dataset.id;
                    if (currentNovelId === novelId) {
                        const novel = allNovels.find(n => n.id === novelId);
                        if (novel) {
                            showNovelDetail(novel);
                        }
                    }
                }
                
            } catch (error) {
                console.error("Error rating novel:", error);
                showNotification("Error submitting rating", "error");
            }
        }

        // Show coin transfer confirmation - UPDATED: 8 coins to author
        function showCoinTransferConfirmation(novel, authorName) {
            pendingNovelRead = novel;
            
            // Update modal content
            document.getElementById('coinTransferFrom').textContent = currentUser.displayName || currentUser.email.split('@')[0];
            document.getElementById('coinTransferTo').textContent = authorName || 'Author';
            document.getElementById('coinTransferBalance').textContent = document.getElementById('userCoins').textContent;
            
            // Reset success message
            coinTransferSuccess.style.display = 'none';
            
            // Show modal
            coinConfirmModal.style.display = 'flex';
        }

        // FIXED: Handle coin transfer and novel reading with better error handling
        // UPDATED: Author gets 8 coins, platform gets 2 coins
        async function processNovelReading(novel) {
            if (!currentUser) {
                showNotification("Please login to read novels", "error");
                return false;
            }
            
            if (userReads.has(novel.id)) {
                return true; // Already read
            }
            
            // Check user coins
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            const currentCoins = userData.coins || 150;
            
            if (currentCoins < 10) {
                showNotification("Not enough coins to read this novel. You need 10 coins.", "error");
                return false;
            }
            
            try {
                // IMPORTANT: First deduct coins from reader
                await db.collection('users').doc(currentUser.uid).update({
                    coins: currentCoins - 10,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Get author's current coins
                const authorDoc = await db.collection('users').doc(novel.userId).get();
                let authorCoins = 150;
                
                if (authorDoc.exists) {
                    authorCoins = authorDoc.data().coins || 150;
                    // Update author's coins (8 coins)
                    await db.collection('users').doc(novel.userId).update({
                        coins: authorCoins + 8,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    // Create author document if doesn't exist
                    await db.collection('users').doc(novel.userId).set({
                        email: novel.userEmail,
                        name: novel.authorName || novel.userEmail.split('@')[0],
                        nickname: novel.authorName || novel.userEmail.split('@')[0],
                        coins: 158, // 150 default + 8 from this transaction
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // Record coin transfer (8 coins to author, 2 coins platform fee)
                await db.collection('coinTransfers').add({
                    fromUserId: currentUser.uid,
                    fromUserEmail: currentUser.email,
                    toUserId: novel.userId,
                    toUserEmail: novel.userEmail,
                    amount: 8, // Author gets 8 coins
                    platformFee: 2, // Platform fee 2 coins
                    novelId: novel.id,
                    novelTitle: novel.title,
                    transferredAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'completed'
                });
                
                // Record the read
                await db.collection('reads').add({
                    userId: currentUser.uid,
                    novelId: novel.id,
                    readAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                userReads.add(novel.id);
                updateUserCoins();
                
                // Show success in modal and banner
                coinTransferSuccess.style.display = 'block';
                showCoinPaymentSuccess();
                
                setTimeout(() => {
                    coinConfirmModal.style.display = 'none';
                    // Load novel detail after successful payment
                    loadNovelDetailContent(novel);
                }, 1500);
                
                return true;
                
            } catch (error) {
                console.error("Error processing novel reading:", error);
                
                // If error occurs, try to refund coins
                try {
                    await db.collection('users').doc(currentUser.uid).update({
                        coins: currentCoins,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    updateUserCoins();
                } catch (refundError) {
                    console.error("Error refunding coins:", refundError);
                }
                
                // Check specific error type
                if (error.code === 'permission-denied') {
                    showNotification("Permission denied. Please check Firebase rules.", "error");
                } else {
                    showNotification("Error processing payment: " + error.message, "error");
                }
                
                return false;
            }
        }

        // Helper function for upload process continuation
        async function continueUploadProcess(title, category, content, imageUrl, cost, currentCoins) {
            try {
                // Deduct coins
                const newCoins = currentCoins - cost;
                await db.collection('users').doc(currentUser.uid).update({
                    coins: newCoins,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Create content document
                const contentData = {
                    title: title,
                    category: category || 'Uncategorized',
                    content: content,
                    imageUrl: imageUrl,
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    authorName: currentUser.displayName || currentUser.email.split('@')[0],
                    likeCount: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Add rating fields for novels
                if (currentUploadType === 'novel') {
                    contentData.averageRating = 0;
                    contentData.ratingCount = 0;
                }
                
                if (isEditing && editingContentId) {
                    // Update existing content
                    await db.collection(`${currentUploadType}s`).doc(editingContentId).update(contentData);
                    showNotification(`${currentUploadType === 'poem' ? 'Poem' : 'Novel'} updated successfully!`, "success");
                } else {
                    // Create new content
                    await db.collection(`${currentUploadType}s`).add(contentData);
                    showNotification(`${currentUploadType === 'poem' ? 'Poem' : 'Novel'} uploaded successfully!`, "success");
                }
                
                // Update user coins in UI
                updateUserCoins();
                
                // Go back to appropriate list
                if (currentUploadType === 'poem') {
                    loadPoems();
                    showSection(poemListContainer);
                } else {
                    loadNovels();
                    showSection(novelListContainer);
                }
                
                // Reload user content for profile
                loadUserContent();
                
            } catch (error) {
                console.error("Error uploading content:", error);
                showNotification("Error uploading content: " + error.message, "error");
            } finally {
                hideLoading();
                const submitUploadBtn = document.getElementById('submitUpload');
                submitUploadBtn.disabled = false;
                submitUploadBtn.innerHTML = `<i class="fas fa-upload"></i> Upload <span id="uploadTypeText">${currentUploadType === 'poem' ? 'Poem' : 'Novel'}</span>
                    <span id="coinCost">(Cost: ${cost} Coins)</span>`;
            }
        }

        // FIXED: Load poems
        function loadPoems() {
            showLoading("Loading poems...");
            db.collection('poems').orderBy('createdAt', 'desc').get()
                .then(querySnapshot => {
                    allPoems = [];
                    const poemsGrid = document.getElementById('poemsGrid');
                    if (!poemsGrid) return;
                    
                    poemsGrid.innerHTML = '';
                    
                    querySnapshot.forEach(doc => {
                        const poem = { id: doc.id, ...doc.data() };
                        poem.isLiked = likedPoems.has(doc.id);
                        allPoems.push(poem);
                        
                        const poemItem = document.createElement('div');
                        poemItem.className = 'poem-item';
                        poemItem.dataset.id = doc.id;
                        
                        const previewText = poem.content.length > 150 
                            ? poem.content.substring(0, 150) + '...' 
                            : poem.content;
                        
                        poemItem.innerHTML = `
                            ${poem.imageUrl ? `<img src="${poem.imageUrl}" alt="${poem.title}" class="item-image">` : 
                            `<div class="item-image" style="background: linear-gradient(45deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                <i class="fas fa-pen-fancy"></i>
                            </div>`}
                            <h3 class="item-title">${poem.title}</h3>
                            <p class="item-author">
                                <i class="fas fa-user"></i>
                                <a href="#" class="view-author-profile" data-user-id="${poem.userId}" data-user-name="${poem.authorName || 'Unknown'}">${poem.authorName || 'Unknown'}</a>
                            </p>
                            <p class="item-preview">${previewText}</p>
                            <div class="like-section">
                                <button class="like-btn ${poem.isLiked ? 'liked' : ''}" data-id="${poem.id}" data-type="poem" data-title="${poem.title}">
                                    <i class="fas fa-heart"></i>
                                </button>
                                <span class="like-count">${poem.likeCount || 0}</span>
                            </div>
                        `;
                        
                        poemItem.addEventListener('click', (e) => {
                            if (!e.target.closest('.like-btn') && !e.target.closest('.view-author-profile')) {
                                showPoemDetail(poem);
                            }
                        });
                        
                        const likeBtn = poemItem.querySelector('.like-btn');
                        likeBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const contentId = e.currentTarget.getAttribute('data-id');
                            const type = e.currentTarget.getAttribute('data-type');
                            const title = e.currentTarget.getAttribute('data-title');
                            showLikeConfirmation(contentId, type, title);
                        });
                        
                        const authorLink = poemItem.querySelector('.view-author-profile');
                        authorLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const userId = authorLink.getAttribute('data-user-id');
                            const userName = authorLink.getAttribute('data-user-name');
                            if (userId && userId !== 'undefined') {
                                showUserProfile(userId, userName);
                            } else {
                                showNotification("Cannot view user profile: User ID not found", "error");
                            }
                        });
                        
                        poemsGrid.appendChild(poemItem);
                    });
                    hideLoading();
                })
                .catch(error => {
                    console.error("Error loading poems:", error);
                    showNotification("Error loading poems", "error");
                    hideLoading();
                });
        }

        // FIXED: Load novels with mobile-friendly rating display
        function loadNovels() {
            showLoading("Loading novels...");
            db.collection('novels').orderBy('createdAt', 'desc').get()
                .then(querySnapshot => {
                    allNovels = [];
                    const novelsGrid = document.getElementById('novelsGrid');
                    if (!novelsGrid) return;
                    
                    novelsGrid.innerHTML = '';
                    
                    querySnapshot.forEach(doc => {
                        const novel = { id: doc.id, ...doc.data() };
                        novel.isLiked = likedNovels.has(doc.id);
                        novel.userRating = ratedNovels.get(doc.id) || 0;
                        allNovels.push(novel);
                        
                        const novelItem = document.createElement('div');
                        novelItem.className = 'novel-item';
                        novelItem.dataset.id = doc.id;
                        
                        const previewText = novel.content.length > 150 
                            ? novel.content.substring(0, 150) + '...' 
                            : novel.content;
                        
                        novelItem.innerHTML = `
                            ${novel.imageUrl ? `<img src="${novel.imageUrl}" alt="${novel.title}" class="item-image">` : 
                            `<div class="item-image" style="background: linear-gradient(45deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                <i class="fas fa-book-open"></i>
                            </div>`}
                            <h3 class="item-title">${novel.title}</h3>
                            <p class="item-author">
                                <i class="fas fa-user"></i>
                                <a href="#" class="view-author-profile" data-user-id="${novel.userId}" data-user-name="${novel.authorName || 'Unknown'}">${novel.authorName || 'Unknown'}</a>
                            </p>
                            <p class="item-preview">${previewText}</p>
                            <div class="like-section">
                                <button class="like-btn ${novel.isLiked ? 'liked' : ''}" data-id="${novel.id}" data-type="novel" data-title="${novel.title}">
                                    <i class="fas fa-heart"></i>
                                </button>
                                <span class="like-count">${novel.likeCount || 0}</span>
                            </div>
                            <div class="rating-section">
                                <div class="stars">
                                    ${[1,2,3,4,5].map(star => `
                                        <button class="star-btn ${novel.userRating >= star ? 'active' : ''}" data-id="${novel.id}" data-rating="${star}">
                                            <i class="fas fa-star"></i>
                                        </button>
                                    `).join('')}
                                </div>
                                <div class="average-rating">
                                    <span>${novel.averageRating ? novel.averageRating.toFixed(1) : '0.0'}</span>
                                </div>
                            </div>
                        `;
                        
                        novelItem.addEventListener('click', (e) => {
                            if (!e.target.closest('.like-btn') && !e.target.closest('.star-btn') && !e.target.closest('.view-author-profile')) {
                                showNovelDetail(novel);
                            }
                        });
                        
                        const likeBtn = novelItem.querySelector('.like-btn');
                        likeBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const contentId = e.currentTarget.getAttribute('data-id');
                            const type = e.currentTarget.getAttribute('data-type');
                            const title = e.currentTarget.getAttribute('data-title');
                            showLikeConfirmation(contentId, type, title);
                        });
                        
                        const starBtns = novelItem.querySelectorAll('.star-btn');
                        starBtns.forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const novelId = btn.getAttribute('data-id');
                                const rating = parseInt(btn.getAttribute('data-rating'));
                                showRatingConfirmation(novelId, rating);
                            });
                        });
                        
                        const authorLink = novelItem.querySelector('.view-author-profile');
                        authorLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const userId = authorLink.getAttribute('data-user-id');
                            const userName = authorLink.getAttribute('data-user-name');
                            if (userId && userId !== 'undefined') {
                                showUserProfile(userId, userName);
                            } else {
                                showNotification("Cannot view user profile: User ID not found", "error");
                            }
                        });
                        
                        novelsGrid.appendChild(novelItem);
                    });
                    hideLoading();
                })
                .catch(error => {
                    console.error("Error loading novels:", error);
                    showNotification("Error loading novels", "error");
                    hideLoading();
                });
        }

        // Load user's content
        function loadUserContent() {
            if (!currentUser) return;
            
            db.collection('poems').where('userId', '==', currentUser.uid).get()
                .then(querySnapshot => {
                    userPoems = [];
                    const myPoemsGrid = document.getElementById('myPoemsGrid');
                    if (!myPoemsGrid) return;
                    
                    myPoemsGrid.innerHTML = '';
                    
                    querySnapshot.forEach(doc => {
                        const poem = { id: doc.id, ...doc.data() };
                        userPoems.push(poem);
                        
                        const poemItem = document.createElement('div');
                        poemItem.className = 'my-item';
                        
                        poemItem.innerHTML = `
                            <div class="my-item-title">${poem.title}</div>
                            <div class="item-actions">
                                <button class="action-btn edit-btn" data-id="${poem.id}" data-type="poem">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete-btn" data-id="${poem.id}" data-type="poem">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        
                        myPoemsGrid.appendChild(poemItem);
                    });
                    
                    // Update poem count
                    document.getElementById('statPoems').textContent = querySnapshot.size;
                })
                .catch(error => {
                    console.error("Error loading user poems:", error);
                })
                .finally(() => {
                    // Now load novels
                    db.collection('novels').where('userId', '==', currentUser.uid).get()
                        .then(querySnapshot => {
                            userNovels = [];
                            const myNovelsGrid = document.getElementById('myNovelsGrid');
                            if (!myNovelsGrid) return;
                            
                            myNovelsGrid.innerHTML = '';
                            
                            querySnapshot.forEach(doc => {
                                const novel = { id: doc.id, ...doc.data() };
                                userNovels.push(novel);
                                
                                const novelItem = document.createElement('div');
                                novelItem.className = 'my-item';
                                
                                novelItem.innerHTML = `
                                    <div class="my-item-title">${novel.title}</div>
                                    <div class="item-actions">
                                        <button class="action-btn edit-btn" data-id="${novel.id}" data-type="novel">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="action-btn delete-btn" data-id="${novel.id}" data-type="novel">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `;
                                
                                myNovelsGrid.appendChild(novelItem);
                            });
                            
                            // Update novel count
                            document.getElementById('statNovels').textContent = querySnapshot.size;
                            
                            hideLoading();
                        })
                        .catch(error => {
                            console.error("Error loading user novels:", error);
                            hideLoading();
                        });
                });
        }

        // Show poem detail
        function showPoemDetail(poem) {
            showLoading("Loading poem...");
            
            document.getElementById('poemDetailTitle').textContent = poem.title;
            document.getElementById('poemDetailTitle').dataset.id = poem.id;
            document.getElementById('poemDetailAuthor').textContent = `By ${poem.authorName || 'Unknown'}`;
            document.getElementById('poemDetailLikeCount').textContent = poem.likeCount || 0;
            document.getElementById('poemDetailContent').textContent = poem.content;
            
            // NEW: Set category and date
            document.getElementById('poemDetailCategory').textContent = poem.category || 'Uncategorized';
            if (poem.createdAt && poem.createdAt.toDate) {
                const date = poem.createdAt.toDate();
                document.getElementById('poemDetailDate').textContent = date.toLocaleDateString();
            } else {
                document.getElementById('poemDetailDate').textContent = 'Unknown';
            }
            
            // Set author info
            document.getElementById('poemAuthorAvatar').textContent = (poem.authorName || 'A').charAt(0).toUpperCase();
            document.getElementById('poemAuthorName').textContent = poem.authorName || 'Unknown';
            document.getElementById('poemAuthorEmail').textContent = poem.userEmail || 'N/A';
            
            // Set like button state
            const likeBtn = document.getElementById('poemDetailLikeBtn');
            likeBtn.classList.toggle('liked', likedPoems.has(poem.id));
            likeBtn.setAttribute('data-id', poem.id);
            likeBtn.setAttribute('data-type', 'poem');
            likeBtn.setAttribute('data-title', poem.title);
            
            // Set author profile button data
            const authorProfileBtn = document.getElementById('poemAuthorProfileBtn');
            authorProfileBtn.setAttribute('data-user-id', poem.userId);
            authorProfileBtn.setAttribute('data-user-name', poem.authorName);
            
            // Load image if exists
            const poemImage = document.getElementById('poemDetailImage');
            if (poem.imageUrl) {
                poemImage.src = poem.imageUrl;
                poemImage.style.display = 'block';
            } else {
                poemImage.style.display = 'none';
            }
            
            showSection(poemDetailContainer);
            hideLoading();
        }

        // Load novel detail content (after coin transfer)
        function loadNovelDetailContent(novel) {
            document.getElementById('novelDetailContent').textContent = novel.content;
        }

        // Show novel detail (with coin check)
        function showNovelDetail(novel) {
            showLoading("Loading novel...");
            
            document.getElementById('novelDetailTitle').textContent = novel.title;
            document.getElementById('novelDetailTitle').dataset.id = novel.id;
            document.getElementById('novelDetailAuthor').textContent = `By ${novel.authorName || 'Unknown'}`;
            document.getElementById('novelDetailLikeCount').textContent = novel.likeCount || 0;
            document.getElementById('novelAverageRating').textContent = novel.averageRating ? novel.averageRating.toFixed(1) : '0.0';
            document.getElementById('novelRatingCount').textContent = novel.ratingCount || 0;
            
            // NEW: Set category and date
            document.getElementById('novelDetailCategory').textContent = novel.category || 'Uncategorized';
            if (novel.createdAt && novel.createdAt.toDate) {
                const date = novel.createdAt.toDate();
                document.getElementById('novelDetailDate').textContent = date.toLocaleDateString();
            } else {
                document.getElementById('novelDetailDate').textContent = 'Unknown';
            }
            
            // Set author info
            document.getElementById('novelAuthorAvatar').textContent = (novel.authorName || 'A').charAt(0).toUpperCase();
            document.getElementById('novelAuthorName').textContent = novel.authorName || 'Unknown';
            document.getElementById('novelAuthorEmail').textContent = novel.userEmail || 'N/A';
            
            // Set like button state
            const likeBtn = document.getElementById('novelDetailLikeBtn');
            likeBtn.classList.toggle('liked', likedNovels.has(novel.id));
            likeBtn.setAttribute('data-id', novel.id);
            likeBtn.setAttribute('data-type', 'novel');
            likeBtn.setAttribute('data-title', novel.title);
            
            // Set rating stars
            const userRating = ratedNovels.get(novel.id) || 0;
            const starBtns = document.querySelectorAll('#novelStars .star-btn');
            starBtns.forEach(btn => {
                const rating = parseInt(btn.getAttribute('data-rating'));
                btn.classList.toggle('active', rating <= userRating);
                btn.setAttribute('data-id', novel.id);
            });
            
            // Set author profile button data
            const authorProfileBtn = document.getElementById('novelAuthorProfileBtn');
            authorProfileBtn.setAttribute('data-user-id', novel.userId);
            authorProfileBtn.setAttribute('data-user-name', novel.authorName);
            
            // Load image if exists
            const novelImage = document.getElementById('novelDetailImage');
            if (novel.imageUrl) {
                novelImage.src = novel.imageUrl;
                novelImage.style.display = 'block';
            } else {
                novelImage.style.display = 'none';
            }
            
            // Check if user has already read this novel or is the author
            if (userReads.has(novel.id) || novel.userId === currentUser.uid) {
                // Already read or is author, show content directly
                document.getElementById('novelDetailContent').textContent = novel.content;
                showSection(novelDetailContainer);
                hideLoading();
            } else {
                // Need to pay coins to read
                document.getElementById('novelDetailContent').textContent = '';
                showCoinTransferConfirmation(novel, novel.authorName);
                showSection(novelDetailContainer);
                hideLoading();
            }
        }

        // Show user profile
        function showUserProfile(userId, userName) {
            showLoading("Loading profile...");
            viewingUserId = userId;
            
            db.collection('users').doc(userId).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        const userProfileContent = document.getElementById('userProfileContent');
                        
                        const userAvatarLetter = (userData.name || userData.nickname || 'U').charAt(0).toUpperCase();
                        const userDisplayName = userData.nickname || userData.name || 'Unknown User';
                        
                        userProfileContent.innerHTML = `
                            <div class="user-profile-header">
                                <div class="user-profile-avatar">${userAvatarLetter}</div>
                                <div class="user-profile-info">
                                    <h3>${userDisplayName}</h3>
                                    <p><i class="fas fa-envelope"></i> ${userData.email}</p>
                                    <p><i class="fas fa-user-tag"></i> ${userData.isAdmin ? 'Admin User' : 'Member'}</p>
                                    <p><i class="fas fa-calendar"></i> Joined: ${new Date(userData.createdAt?.toDate()).toLocaleDateString()}</p>
                                </div>
                            </div>
                            
                            <div class="user-profile-stats">
                                <div class="user-profile-stat">
                                    <div class="user-profile-stat-value" id="userStatPoems">0</div>
                                    <div class="user-profile-stat-label">Poems</div>
                                </div>
                                <div class="user-profile-stat">
                                    <div class="user-profile-stat-value" id="userStatNovels">0</div>
                                    <div class="user-profile-stat-label">Novels</div>
                                </div>
                                <div class="user-profile-stat">
                                    <div class="user-profile-stat-value">${userData.coins || 0}</div>
                                    <div class="user-profile-stat-label">Coins</div>
                                </div>
                            </div>
                            
                            <div class="user-content-section">
                                <h4><i class="fas fa-pen-fancy"></i> Poems by ${userDisplayName}</h4>
                                <div class="user-content-grid" id="userPoemsGrid">
                                    <!-- User's poems will be loaded here -->
                                </div>
                            </div>
                            
                            <div class="user-content-section">
                                <h4><i class="fas fa-book-open"></i> Novels by ${userDisplayName}</h4>
                                <div class="user-content-grid" id="userNovelsGrid">
                                    <!-- User's novels will be loaded here -->
                                </div>
                            </div>
                        `;
                        
                        // Load user's poems
                        db.collection('poems').where('userId', '==', userId).limit(12).get()
                            .then(querySnapshot => {
                                const userPoemsGrid = document.getElementById('userPoemsGrid');
                                const userStatPoems = document.getElementById('userStatPoems');
                                
                                if (userStatPoems) {
                                    userStatPoems.textContent = querySnapshot.size;
                                }
                                
                                if (userPoemsGrid) {
                                    userPoemsGrid.innerHTML = '';
                                    
                                    querySnapshot.forEach(doc => {
                                        const poem = { id: doc.id, ...doc.data() };
                                        
                                        const poemItem = document.createElement('div');
                                        poemItem.className = 'user-content-item';
                                        poemItem.dataset.id = doc.id;
                                        poemItem.dataset.type = 'poem';
                                        
                                        const previewText = poem.content.length > 100 
                                            ? poem.content.substring(0, 100) + '...' 
                                            : poem.content;
                                        
                                        poemItem.innerHTML = `
                                            ${poem.imageUrl ? `<img src="${poem.imageUrl}" alt="${poem.title}" class="user-content-image">` : 
                                            `<div class="user-content-image" style="background: linear-gradient(45deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                                <i class="fas fa-pen-fancy"></i>
                                            </div>`}
                                            <h4 class="user-content-title">${poem.title}</h4>
                                            <div class="user-content-meta">
                                                <span><i class="fas fa-heart"></i> ${poem.likeCount || 0}</span>
                                                <span>${poem.category || 'Uncategorized'}</span>
                                            </div>
                                        `;
                                        
                                        poemItem.addEventListener('click', () => {
                                            showPoemDetail(poem);
                                        });
                                        
                                        userPoemsGrid.appendChild(poemItem);
                                    });
                                }
                                
                                // Load user's novels
                                return db.collection('novels').where('userId', '==', userId).limit(12).get();
                            })
                            .then(querySnapshot => {
                                const userNovelsGrid = document.getElementById('userNovelsGrid');
                                const userStatNovels = document.getElementById('userStatNovels');
                                
                                if (userStatNovels) {
                                    userStatNovels.textContent = querySnapshot.size;
                                }
                                
                                if (userNovelsGrid) {
                                    userNovelsGrid.innerHTML = '';
                                    
                                    querySnapshot.forEach(doc => {
                                        const novel = { id: doc.id, ...doc.data() };
                                        
                                        const novelItem = document.createElement('div');
                                        novelItem.className = 'user-content-item';
                                        novelItem.dataset.id = doc.id;
                                        novelItem.dataset.type = 'novel';
                                        
                                        const previewText = novel.content.length > 100 
                                            ? novel.content.substring(0, 100) + '...' 
                                            : novel.content;
                                        
                                        novelItem.innerHTML = `
                                            ${novel.imageUrl ? `<img src="${novel.imageUrl}" alt="${novel.title}" class="user-content-image">` : 
                                            `<div class="user-content-image" style="background: linear-gradient(45deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                                <i class="fas fa-book-open"></i>
                                            </div>`}
                                            <h4 class="user-content-title">${novel.title}</h4>
                                            <div class="user-content-meta">
                                                <span><i class="fas fa-heart"></i> ${novel.likeCount || 0}</span>
                                                <span><i class="fas fa-star"></i> ${novel.averageRating ? novel.averageRating.toFixed(1) : '0.0'}</span>
                                                <span>${novel.category || 'Uncategorized'}</span>
                                            </div>
                                        `;
                                        
                                        novelItem.addEventListener('click', () => {
                                            showNovelDetail(novel);
                                        });
                                        
                                        userNovelsGrid.appendChild(novelItem);
                                    });
                                }
                                
                                showSection(userProfileContainer);
                                hideLoading();
                            })
                            .catch(error => {
                                console.error("Error loading user content:", error);
                                showNotification("Error loading user profile", "error");
                                hideLoading();
                            });
                    } else {
                        showNotification("User not found", "error");
                        hideLoading();
                    }
                })
                .catch(error => {
                    console.error("Error loading user profile:", error);
                    showNotification("Error loading user profile", "error");
                    hideLoading();
                });
        }

        // Initialize upload form
        function initUploadForm(type) {
            currentUploadType = type;
            isEditing = false;
            editingContentId = null;
            
            const uploadTitle = document.getElementById('uploadTitle');
            const uploadCategory = document.getElementById('uploadCategory');
            const uploadContent = document.getElementById('uploadContent');
            const imagePreview = document.getElementById('imagePreview');
            const uploadType = document.getElementById('uploadType');
            const uploadTypeText = document.getElementById('uploadTypeText');
            const coinCost = document.getElementById('coinCost');
            const currentCoins = document.getElementById('currentCoins');
            const submitUploadBtn = document.getElementById('submitUpload');
            
            // Reset form
            uploadTitle.value = '';
            uploadCategory.value = '';
            uploadContent.value = '';
            imagePreview.src = '';
            imagePreview.style.display = 'none';
            uploadProgress.style.display = 'none';
            uploadProgressBar.style.width = '0%';
            
            // Enable upload button
            submitUploadBtn.disabled = false;
            submitUploadBtn.innerHTML = `<i class="fas fa-upload"></i> Upload <span id="uploadTypeText">Poem</span>
                <span id="coinCost">(Cost: ${type === 'poem' ? '5' : '10'} Coins)</span>`;
            
            // Set type-specific values
            const typeText = type === 'poem' ? 'Poem' : 'Novel';
            uploadType.textContent = typeText;
            uploadTypeText.textContent = typeText;
            
            // Set coin cost
            coinCost.textContent = `(Cost: ${type === 'poem' ? '5' : '10'} Coins)`;
            
            // Update current coins
            if (currentUser) {
                updateUserCoins();
            }
            
            // Show upload section
            showSection(uploadContainer);
        }

        // FIXED: Setup upload image with progress tracking
        function setupUploadImage() {
            const uploadArea = document.getElementById('uploadArea');
            const imageUpload = document.getElementById('imageUpload');
            const imagePreview = document.getElementById('imagePreview');
            
            uploadArea.addEventListener('click', () => {
                imageUpload.click();
            });
            
            imageUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Validate file type
                    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                    if (!validTypes.includes(file.type)) {
                        showNotification("Please upload a valid image file (JPEG, PNG, GIF, WebP)", "error");
                        return;
                    }
                    
                    // Validate file size (5MB limit)
                    if (file.size > 5 * 1024 * 1024) {
                        showNotification("Image size should be less than 5MB", "error");
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--primary)';
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '';
                
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    imageUpload.files = e.dataTransfer.files;
                    
                    // Validate file type
                    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                    if (!validTypes.includes(file.type)) {
                        showNotification("Please upload a valid image file (JPEG, PNG, GIF, WebP)", "error");
                        return;
                    }
                    
                    // Validate file size (5MB limit)
                    if (file.size > 5 * 1024 * 1024) {
                        showNotification("Image size should be less than 5MB", "error");
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    showNotification("Please drop an image file", "error");
                }
            });
        }

        // FIXED: Submit upload with progress tracking
        async function submitUpload() {
            const title = document.getElementById('uploadTitle').value.trim();
            const category = document.getElementById('uploadCategory').value.trim();
            const content = document.getElementById('uploadContent').value.trim();
            const imageFile = document.getElementById('imageUpload').files[0];
            const submitUploadBtn = document.getElementById('submitUpload');
            
            if (!title || !content) {
                showNotification("Please fill in all required fields", "error");
                return;
            }
            
            if (!currentUser) {
                showNotification("Please login to upload content", "error");
                return;
            }
            
            // Check user coins
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            const currentCoins = userData.coins || 150;
            const cost = currentUploadType === 'poem' ? 5 : 10;
            
            if (currentCoins < cost) {
                showNotification(`Not enough coins! You need ${cost} coins to upload a ${currentUploadType}.`, "error");
                return;
            }
            
            // Disable upload button to prevent multiple submissions
            submitUploadBtn.disabled = true;
            submitUploadBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Uploading...`;
            
            showLoading(`Uploading ${currentUploadType}...`);
            
            try {
                let imageUrl = '';
                
                // Upload image if exists
                if (imageFile) {
                    uploadProgress.style.display = 'block';
                    
                    const storageRef = storage.ref();
                    const imageRef = storageRef.child(`${currentUploadType}s/${currentUser.uid}/${Date.now()}_${imageFile.name}`);
                    
                    // Upload with progress tracking
                    const uploadTask = imageRef.put(imageFile);
                    
                    // Listen for state changes, errors, and completion
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            // Progress tracking
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            uploadProgressBar.style.width = progress + '%';
                        },
                        (error) => {
                            // Handle unsuccessful uploads
                            console.error("Image upload error:", error);
                            showNotification("Error uploading image: " + error.message, "error");
                            hideLoading();
                            submitUploadBtn.disabled = false;
                            submitUploadBtn.innerHTML = `<i class="fas fa-upload"></i> Upload <span id="uploadTypeText">${currentUploadType === 'poem' ? 'Poem' : 'Novel'}</span>
                                <span id="coinCost">(Cost: ${cost} Coins)</span>`;
                        },
                        async () => {
                            // Image uploaded successfully
                            imageUrl = await uploadTask.snapshot.ref.getDownloadURL();
                            
                            // Continue with the rest of the upload process
                            continueUploadProcess(title, category, content, imageUrl, cost, currentCoins);
                        }
                    );
                } else {
                    // No image to upload, continue directly
                    continueUploadProcess(title, category, content, imageUrl, cost, currentCoins);
                }
                
            } catch (error) {
                console.error("Error uploading content:", error);
                showNotification("Error uploading content: " + error.message, "error");
                hideLoading();
                submitUploadBtn.disabled = false;
                submitUploadBtn.innerHTML = `<i class="fas fa-upload"></i> Upload <span id="uploadTypeText">${currentUploadType === 'poem' ? 'Poem' : 'Novel'}</span>
                    <span id="coinCost">(Cost: ${cost} Coins)</span>`;
            }
        }

        // Delete content
        async function deleteContent(contentId, type) {
            if (!confirm(`Are you sure you want to delete this ${type}? This action cannot be undone.`)) {
                return;
            }
            
            showLoading(`Deleting ${type}...`);
            
            try {
                // Delete content document
                await db.collection(`${type}s`).doc(contentId).delete();
                
                // Delete associated likes
                const likesSnapshot = await db.collection(`${type}s`).doc(contentId).collection('likes').get();
                const deleteLikesPromises = [];
                likesSnapshot.forEach(doc => {
                    deleteLikesPromises.push(doc.ref.delete());
                });
                await Promise.all(deleteLikesPromises);
                
                // Delete ratings if it's a novel
                if (type === 'novel') {
                    const ratingsSnapshot = await db.collection('novels').doc(contentId).collection('ratings').get();
                    const deleteRatingsPromises = [];
                    ratingsSnapshot.forEach(doc => {
                        deleteRatingsPromises.push(doc.ref.delete());
                    });
                    await Promise.all(deleteRatingsPromises);
                }
                
                showNotification(`${type === 'poem' ? 'Poem' : 'Novel'} deleted successfully`, "success");
                
                // Refresh the view
                if (type === 'poem') {
                    loadPoems();
                    if (userProfileContainer.style.display === 'block') {
                        loadUserContent();
                    }
                } else {
                    loadNovels();
                    if (userProfileContainer.style.display === 'block') {
                        loadUserContent();
                    }
                }
                
                // If we're in the detail view, go back
                if (type === 'poem' && poemDetailContainer.style.display === 'block') {
                    showSection(poemListContainer);
                } else if (type === 'novel' && novelDetailContainer.style.display === 'block') {
                    showSection(novelListContainer);
                }
                
            } catch (error) {
                console.error("Error deleting content:", error);
                showNotification("Error deleting content", "error");
            } finally {
                hideLoading();
            }
        }

        // Edit content
        function editContent(contentId, type) {
            isEditing = true;
            editingContentId = contentId;
            currentUploadType = type;
            
            const collection = type === 'poem' ? userPoems : userNovels;
            const content = collection.find(item => item.id === contentId);
            
            if (!content) {
                showNotification("Content not found", "error");
                return;
            }
            
            const uploadTitle = document.getElementById('uploadTitle');
            const uploadCategory = document.getElementById('uploadCategory');
            const uploadContent = document.getElementById('uploadContent');
            const imagePreview = document.getElementById('imagePreview');
            const uploadType = document.getElementById('uploadType');
            const uploadTypeText = document.getElementById('uploadTypeText');
            const coinCost = document.getElementById('coinCost');
            const submitUploadBtn = document.getElementById('submitUpload');
            
            // Fill form with existing data
            uploadTitle.value = content.title;
            uploadCategory.value = content.category || '';
            uploadContent.value = content.content;
            
            if (content.imageUrl) {
                imagePreview.src = content.imageUrl;
                imagePreview.style.display = 'block';
            } else {
                imagePreview.style.display = 'none';
            }
            
            // Set type-specific values
            const typeText = type === 'poem' ? 'Poem' : 'Novel';
            uploadType.textContent = typeText;
            uploadTypeText.textContent = typeText;
            
            // Set coin cost (editing is free)
            coinCost.textContent = '(Editing: Free)';
            
            // Update button text
            submitUploadBtn.innerHTML = `<i class="fas fa-save"></i> Update <span id="uploadTypeText">${typeText}</span>
                <span id="coinCost">(Editing: Free)</span>`;
            
            // Show upload section
            showSection(uploadContainer);
        }

        // Load admin users
        function loadAdminUsers() {
            showLoading("Loading users...");
            db.collection('users').get()
                .then(querySnapshot => {
                    adminUsers = [];
                    const adminUsersList = document.getElementById('adminUsersList');
                    if (!adminUsersList) return;
                    
                    adminUsersList.innerHTML = '';
                    
                    querySnapshot.forEach(doc => {
                        const user = { id: doc.id, ...doc.data() };
                        adminUsers.push(user);
                        
                        const userItem = document.createElement('div');
                        userItem.className = 'admin-list-item';
                        
                        userItem.innerHTML = `
                            <div class="admin-list-item-info">
                                <h4>${user.nickname || user.name || 'Unknown'}</h4>
                                <p>${user.email} | ${user.isAdmin ? 'Admin' : 'User'} | Coins: ${user.coins || 0}</p>
                                <p>Joined: ${user.createdAt ? new Date(user.createdAt.toDate()).toLocaleDateString() : 'N/A'}</p>
                            </div>
                            <div class="admin-list-item-actions">
                                <button class="admin-action-btn admin-add-coin-btn" data-user-id="${doc.id}" data-user-name="${user.nickname || user.name}">
                                    <i class="fas fa-plus-circle"></i> Add Coins
                                </button>
                                <button class="admin-action-btn admin-remove-coin-btn" data-user-id="${doc.id}" data-user-name="${user.nickname || user.name}">
                                    <i class="fas fa-minus-circle"></i> Remove Coins
                                </button>
                                ${!user.isAdmin ? `<button class="admin-action-btn admin-delete-btn" data-user-id="${doc.id}" data-user-name="${user.nickname || user.name}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>` : ''}
                            </div>
                        `;
                        
                        adminUsersList.appendChild(userItem);
                    });
                    
                    // Populate user select for coin management
                    const coinUserSelect = document.getElementById('coinUserSelect');
                    const adminMessageRecipients = document.getElementById('messageRecipient');
                    
                    if (coinUserSelect) {
                        coinUserSelect.innerHTML = '<option value="">Select a user...</option>' +
                            querySnapshot.docs.map(doc => {
                                const user = doc.data();
                                return `<option value="${doc.id}">${user.nickname || user.name} (${user.email}) - ${user.coins || 0} coins</option>`;
                            }).join('');
                    }
                    
                    if (adminMessageRecipients) {
                        adminMessageRecipients.innerHTML = '<option value="all">All Users (Broadcast)</option>' +
                            querySnapshot.docs.map(doc => {
                                const user = doc.data();
                                return `<option value="${doc.id}">${user.nickname || user.name} (${user.email})</option>`;
                            }).join('');
                    }
                    
                    hideLoading();
                })
                .catch(error => {
                    console.error("Error loading admin users:", error);
                    showNotification("Error loading users", "error");
                    hideLoading();
                });
        }

        // Load admin poems
        function loadAdminPoems() {
            db.collection('poems').orderBy('createdAt', 'desc').get()
                .then(querySnapshot => {
                    adminPoems = [];
                    const adminPoemsList = document.getElementById('adminPoemsList');
                    if (!adminPoemsList) return;
                    
                    adminPoemsList.innerHTML = '';
                    
                    querySnapshot.forEach(doc => {
                        const poem = { id: doc.id, ...doc.data() };
                        adminPoems.push(poem);
                        
                        const poemItem = document.createElement('div');
                        poemItem.className = 'admin-list-item';
                        
                        poemItem.innerHTML = `
                            <div class="admin-list-item-info">
                                <h4>${poem.title}</h4>
                                <p>By: ${poem.authorName || 'Unknown'} | Likes: ${poem.likeCount || 0} | Category: ${poem.category || 'Uncategorized'}</p>
                                <p>Created: ${poem.createdAt ? new Date(poem.createdAt.toDate()).toLocaleDateString() : 'N/A'}</p>
                            </div>
                            <div class="admin-list-item-actions">
                                <button class="admin-action-btn admin-delete-btn" data-content-id="${doc.id}" data-type="poem" data-title="${poem.title}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        `;
                        
                        adminPoemsList.appendChild(poemItem);
                    });
                })
                .catch(error => {
                    console.error("Error loading admin poems:", error);
                    showNotification("Error loading poems", "error");
                });
        }

        // Load admin novels
        function loadAdminNovels() {
            db.collection('novels').orderBy('createdAt', 'desc').get()
                .then(querySnapshot => {
                    adminNovels = [];
                    const adminNovelsList = document.getElementById('adminNovelsList');
                    if (!adminNovelsList) return;
                    
                    adminNovelsList.innerHTML = '';
                    
                    querySnapshot.forEach(doc => {
                        const novel = { id: doc.id, ...doc.data() };
                        adminNovels.push(novel);
                        
                        const novelItem = document.createElement('div');
                        novelItem.className = 'admin-list-item';
                        
                        novelItem.innerHTML = `
                            <div class="admin-list-item-info">
                                <h4>${novel.title}</h4>
                                <p>By: ${novel.authorName || 'Unknown'} | Likes: ${novel.likeCount || 0} | Ratings: ${novel.averageRating ? novel.averageRating.toFixed(1) : '0.0'} (${novel.ratingCount || 0})</p>
                                <p>Created: ${novel.createdAt ? new Date(novel.createdAt.toDate()).toLocaleDateString() : 'N/A'}</p>
                            </div>
                            <div class="admin-list-item-actions">
                                <button class="admin-action-btn admin-delete-btn" data-content-id="${doc.id}" data-type="novel" data-title="${novel.title}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        `;
                        
                        adminNovelsList.appendChild(novelItem);
                    });
                })
                .catch(error => {
                    console.error("Error loading admin novels:", error);
                    showNotification("Error loading novels", "error");
                });
        }

        // Load admin transactions
        function loadAdminTransactions() {
            db.collection('coinTransfers').orderBy('transferredAt', 'desc').limit(20).get()
                .then(querySnapshot => {
                    adminTransactions = [];
                    const transactionsList = document.getElementById('transactionsList');
                    if (!transactionsList) return;
                    
                    transactionsList.innerHTML = '';
                    
                    querySnapshot.forEach(doc => {
                        const transaction = { id: doc.id, ...doc.data() };
                        adminTransactions.push(transaction);
                        
                        const transactionItem = document.createElement('div');
                        transactionItem.className = `transaction-item added`;
                        
                        transactionItem.innerHTML = `
                            <div class="transaction-header">
                                <div class="transaction-amount added">+8 coins</div>
                                <div>${transaction.transferredAt ? new Date(transaction.transferredAt.toDate()).toLocaleString() : 'N/A'}</div>
                            </div>
                            <div class="transaction-details">
                                <p><strong>From:</strong> ${transaction.fromUserEmail}</p>
                                <p><strong>To:</strong> ${transaction.toUserEmail}</p>
                                <p><strong>Platform Fee:</strong> 2 coins</p>
                                <p><strong>Novel:</strong> ${transaction.novelTitle}</p>
                            </div>
                        `;
                        
                        transactionsList.appendChild(transactionItem);
                    });
                })
                .catch(error => {
                    console.error("Error loading transactions:", error);
                    showNotification("Error loading transactions", "error");
                });
        }

        // Load admin statistics
        function loadAdminStatistics() {
            // Total users
            db.collection('users').get()
                .then(querySnapshot => {
                    document.getElementById('adminTotalUsers').textContent = querySnapshot.size;
                });
            
            // Total poems
            db.collection('poems').get()
                .then(querySnapshot => {
                    document.getElementById('adminTotalPoems').textContent = querySnapshot.size;
                });
            
            // Total novels
            db.collection('novels').get()
                .then(querySnapshot => {
                    document.getElementById('adminTotalNovels').textContent = querySnapshot.size;
                });
            
            // Total coins (sum of all users' coins)
            db.collection('users').get()
                .then(querySnapshot => {
                    let totalCoins = 0;
                    querySnapshot.forEach(doc => {
                        const userData = doc.data();
                        totalCoins += userData.coins || 0;
                    });
                    document.getElementById('adminTotalCoins').textContent = totalCoins;
                });
            
            // Load recent activity
            const activityList = document.getElementById('activityList');
            if (activityList) {
                activityList.innerHTML = `
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-user">Admin</div>
                            <div>Accessed admin panel</div>
                            <div class="activity-time">Just now</div>
                        </div>
                    </div>
                `;
            }
        }

        // Manage user coins (admin function)
        async function manageUserCoins(userId, action, amount, reason) {
            if (!userId || !amount || amount <= 0) {
                showNotification("Please select a user and enter a valid amount", "error");
                return;
            }
            
            showLoading(`Processing ${action}...`);
            
            try {
                const userRef = db.collection('users').doc(userId);
                const userDoc = await userRef.get();
                
                if (!userDoc.exists) {
                    showNotification("User not found", "error");
                    hideLoading();
                    return;
                }
                
                const userData = userDoc.data();
                let newCoins = userData.coins || 0;
                
                // Perform action
                if (action === 'add') {
                    newCoins += parseInt(amount);
                } else if (action === 'remove') {
                    newCoins = Math.max(0, newCoins - parseInt(amount));
                } else if (action === 'set') {
                    newCoins = parseInt(amount);
                }
                
                // Update user coins
                await userRef.update({
                    coins: newCoins,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Record transaction
                await db.collection('coinTransactions').add({
                    userId: userId,
                    userEmail: userData.email,
                    action: action,
                    amount: parseInt(amount),
                    previousCoins: userData.coins || 0,
                    newCoins: newCoins,
                    reason: reason || 'Admin adjustment',
                    adminId: currentUser.uid,
                    adminEmail: currentUser.email,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification(`${action === 'add' ? 'Added' : action === 'remove' ? 'Removed' : 'Set'} ${amount} coins for ${userData.nickname || userData.name}`, "success");
                
                // Refresh admin users list
                loadAdminUsers();
                loadAdminTransactions();
                
            } catch (error) {
                console.error("Error managing user coins:", error);
                showNotification("Error managing coins: " + error.message, "error");
            } finally {
                hideLoading();
            }
        }

        // FIXED: Send admin message with image upload
        async function sendAdminMessage() {
            const recipientId = messageRecipient.value;
            const title = adminMessageTitle.value.trim();
            const text = adminMessageText.value.trim();
            const imageFile = adminMessageImage.files[0];
            const btn = sendAdminMessageBtn;

            if (!title || !text) { 
                showNotification("Please fill in title and message content", "error");
                return; 
            }

            try {
                btn.disabled = true;
                btn.innerHTML = "Sending...";

                let imageUrl = null;
                if (imageFile) {
                    // Upload image to Firebase Storage
                    const storageRef = storage.ref();
                    const imageRef = storageRef.child(`admin-messages/${Date.now()}_${imageFile.name}`);
                    await imageRef.put(imageFile);
                    imageUrl = await imageRef.getDownloadURL();
                }

                // Create message in Firestore
                await db.collection('admin_messages').add({
                    title: title,
                    content: text,
                    image: imageUrl,
                    recipientId: recipientId,
                    senderId: currentUser.uid,
                    senderEmail: currentUser.email,
                    senderName: currentUser.displayName || currentUser.email.split('@')[0],
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    readBy: []
                });

                showNotification("Message sent successfully!", "success");
                
                // Reset form
                adminMessageTitle.value = '';
                adminMessageText.value = '';
                adminMessageImage.value = '';
                messageImagePreview.style.display = 'none';
                
            } catch (error) {
                console.error("Error sending message:", error);
                showNotification("Failed to send message: " + error.message, "error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = "Send Message";
            }
        }

        // FIXED: Check user messages and show popup
        function checkUserMessages(userId) {
            if (!userId) return;
            
            db.collection('admin_messages')
                .where('recipientId', 'in', ['all', userId])
                .orderBy('timestamp', 'desc')
                .onSnapshot(snapshot => {
                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        // Check if user hasn't read this message yet
                        if (!msg.readBy || !msg.readBy.includes(userId)) {
                            // Show popup
                            showAdminMessagePopup(doc.id, msg);
                        }
                    });
                });
        }

        // FIXED: Show admin message popup
        function showAdminMessagePopup(docId, msg) {
            currentMessageId = docId;
            
            popupTitle.textContent = msg.title;
            popupText.textContent = msg.content;
            
            if (msg.image) {
                popupImage.src = msg.image;
                popupImage.style.display = 'block';
            } else {
                popupImage.style.display = 'none';
            }
            
            adminMessagePopup.classList.add('show');
            
            // Mark as read when shown
            markMessageAsRead(docId);
        }

        // Mark message as read
        async function markMessageAsRead(docId) {
            if (!currentUser || !docId) return;
            
            try {
                await db.collection('admin_messages').doc(docId).update({
                    readBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                });
            } catch (error) {
                console.error("Error marking message as read:", error);
            }
        }

        // Initialize the app
        function initApp() {
            initBubbles();
            setupUploadImage();
            
            // Hide logo after animation
            setTimeout(() => {
                verseLogo.style.display = 'none';
            }, 2000);
            
            // Check auth state
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    authContainer.style.display = 'none';
                    showSection(dashboard);
                    updateUserInfo(user);
                    checkAdminStatus(user);
                    loadUserLikesAndRatings();
                    loadPoems();
                    loadNovels();
                    checkUserMessages(user.uid);
                    
                    // Check if user document exists
                    db.collection('users').doc(user.uid).get()
                        .then(doc => {
                            if (!doc.exists) {
                                // Create user document if doesn't exist
                                db.collection('users').doc(user.uid).set({
                                    email: user.email,
                                    name: user.displayName || user.email.split('@')[0],
                                    nickname: user.displayName || user.email.split('@')[0],
                                    isAdmin: adminEmails.includes(user.email),
                                    coins: 150,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                        });
                } else {
                    // User is signed out
                    currentUser = null;
                    authContainer.style.display = 'flex';
                    showSection(null);
                }
            });
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            
            // Theme toggle
            themeToggle.addEventListener('click', () => {
                const body = document.body;
                const icon = themeToggle.querySelector('i');
                
                if (body.classList.contains('dark-mode')) {
                    body.classList.remove('dark-mode');
                    body.classList.add('light-mode');
                    icon.className = 'fas fa-sun';
                } else {
                    body.classList.remove('light-mode');
                    body.classList.add('dark-mode');
                    icon.className = 'fas fa-moon';
                }
            });
            
            // Auth tabs
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    
                    // Update active tab
                    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show correct form
                    document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
                    document.getElementById(`${tabName}Form`).classList.add('active');
                });
            });
            
            // Login form
            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    showNotification("Please fill in all fields", "error");
                    return;
                }
                
                showLoading("Logging in...");
                
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        showNotification("Login successful!", "success");
                        hideLoading();
                    })
                    .catch((error) => {
                        console.error("Login error:", error);
                        showNotification("Login failed: " + error.message, "error");
                        hideLoading();
                    });
            });
            
            // Signup form
            document.getElementById('signupForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const name = document.getElementById('signupName').value;
                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;
                const nickname = document.getElementById('signupNickname').value;
                
                if (!name || !email || !password || !nickname) {
                    showNotification("Please fill in all fields", "error");
                    return;
                }
                
                showLoading("Creating account...");
                
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // Update user profile
                        return userCredential.user.updateProfile({
                            displayName: nickname
                        }).then(() => {
                            // Create user document
                            return db.collection('users').doc(userCredential.user.uid).set({
                                email: email,
                                name: name,
                                nickname: nickname,
                                isAdmin: adminEmails.includes(email),
                                coins: 150,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        });
                    })
                    .then(() => {
                        showNotification("Account created successfully!", "success");
                        hideLoading();
                    })
                    .catch((error) => {
                        console.error("Signup error:", error);
                        showNotification("Signup failed: " + error.message, "error");
                        hideLoading();
                    });
            });
            
            // Navigation
            poemSelection.addEventListener('click', () => {
                showSection(poemListContainer);
            });
            
            novelSelection.addEventListener('click', () => {
                showSection(novelListContainer);
            });
            
            // Back buttons
            document.getElementById('backFromPoemList').addEventListener('click', () => {
                showSection(dashboard);
            });
            
            document.getElementById('backFromNovelList').addEventListener('click', () => {
                showSection(dashboard);
            });
            
            document.getElementById('backFromPoemDetail').addEventListener('click', () => {
                showSection(poemListContainer);
            });
            
            document.getElementById('backFromNovelDetail').addEventListener('click', () => {
                showSection(novelListContainer);
            });
            
            document.getElementById('backFromUpload').addEventListener('click', () => {
                if (currentUploadType === 'poem') {
                    showSection(poemListContainer);
                } else {
                    showSection(novelListContainer);
                }
            });
            
            document.getElementById('backFromProfile').addEventListener('click', () => {
                showSection(dashboard);
            });
            
            document.getElementById('backFromUserProfile').addEventListener('click', () => {
                // Go back to previous section
                if (poemDetailContainer.style.display === 'block') {
                    showSection(poemListContainer);
                } else if (novelDetailContainer.style.display === 'block') {
                    showSection(novelListContainer);
                } else {
                    showSection(dashboard);
                }
            });
            
            document.getElementById('backFromAdminPanel').addEventListener('click', () => {
                showSection(dashboard);
            });
            
            // User profile button
            document.getElementById('userProfileBtn').addEventListener('click', () => {
                showSection(profileContainer);
                loadUserContent();
            });
            
            // Logout buttons
            document.getElementById('logoutBtn').addEventListener('click', logoutUser);
            document.getElementById('logoutBtnProfile').addEventListener('click', logoutUser);
            
            // FIXED: Floating add button
            floatingAddBtn.addEventListener('click', () => {
                // Check which section is currently visible
                if (dashboard.style.display === 'block') {
                    // In dashboard, ask what to upload
                    if (confirm("Upload a poem?")) {
                        initUploadForm('poem');
                    } else {
                        initUploadForm('novel');
                    }
                } else if (poemListContainer.style.display === 'block') {
                    // In poem list, upload a poem
                    initUploadForm('poem');
                } else if (novelListContainer.style.display === 'block') {
                    // In novel list, upload a novel
                    initUploadForm('novel');
                } else if (profileContainer.style.display === 'block') {
                    // In profile, ask what to upload
                    if (confirm("Upload a poem?")) {
                        initUploadForm('poem');
                    } else {
                        initUploadForm('novel');
                    }
                }
            });
            
            // Admin access button
            adminAccessBtn.addEventListener('click', () => {
                showSection(adminPanelContainer);
                loadAdminUsers();
                loadAdminPoems();
                loadAdminNovels();
                loadAdminTransactions();
                loadAdminStatistics();
            });
            
            // Upload submit
            document.getElementById('submitUpload').addEventListener('click', submitUpload);
            
            // Poem detail like button
            document.getElementById('poemDetailLikeBtn').addEventListener('click', (e) => {
                const contentId = e.currentTarget.getAttribute('data-id');
                const type = e.currentTarget.getAttribute('data-type');
                const title = e.currentTarget.getAttribute('data-title');
                showLikeConfirmation(contentId, type, title);
            });
            
            // Novel detail like button
            document.getElementById('novelDetailLikeBtn').addEventListener('click', (e) => {
                const contentId = e.currentTarget.getAttribute('data-id');
                const type = e.currentTarget.getAttribute('data-type');
                const title = e.currentTarget.getAttribute('data-title');
                showLikeConfirmation(contentId, type, title);
            });
            
            // Novel detail rating stars
            document.querySelectorAll('#novelStars .star-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const novelId = btn.getAttribute('data-id');
                    const rating = parseInt(btn.getAttribute('data-rating'));
                    showRatingConfirmation(novelId, rating);
                });
            });
            
            // Author profile buttons
            document.getElementById('poemAuthorProfileBtn').addEventListener('click', (e) => {
                const userId = e.currentTarget.getAttribute('data-user-id');
                const userName = e.currentTarget.getAttribute('data-user-name');
                if (userId && userId !== 'undefined') {
                    showUserProfile(userId, userName);
                }
            });
            
            document.getElementById('novelAuthorProfileBtn').addEventListener('click', (e) => {
                const userId = e.currentTarget.getAttribute('data-user-id');
                const userName = e.currentTarget.getAttribute('data-user-name');
                if (userId && userId !== 'undefined') {
                    showUserProfile(userId, userName);
                }
            });
            
            // Search functionality
            document.getElementById('poemSearch').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const poemItems = document.querySelectorAll('.poem-item');
                
                poemItems.forEach(item => {
                    const title = item.querySelector('.item-title').textContent.toLowerCase();
                    const author = item.querySelector('.item-author').textContent.toLowerCase();
                    
                    if (title.includes(searchTerm) || author.includes(searchTerm)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
            
            document.getElementById('novelSearch').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const novelItems = document.querySelectorAll('.novel-item');
                
                novelItems.forEach(item => {
                    const title = item.querySelector('.item-title').textContent.toLowerCase();
                    const author = item.querySelector('.item-author').textContent.toLowerCase();
                    
                    if (title.includes(searchTerm) || author.includes(searchTerm)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
            
            // Admin search
            document.getElementById('adminUserSearch').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const userItems = document.querySelectorAll('#adminUsersList .admin-list-item');
                
                userItems.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
            
            // Coin confirmation
            coinConfirmYes.addEventListener('click', async () => {
                if (pendingNovelRead) {
                    const success = await processNovelReading(pendingNovelRead);
                    if (!success) {
                        coinConfirmModal.style.display = 'none';
                    }
                }
            });
            
            coinConfirmNo.addEventListener('click', () => {
                coinConfirmModal.style.display = 'none';
                pendingNovelRead = null;
            });
            
            // Like confirmation
            likeConfirmYes.addEventListener('click', () => {
                if (pendingLikeAction) {
                    toggleLike(pendingLikeAction.contentId, pendingLikeAction.type);
                    likeConfirmModal.style.display = 'none';
                    pendingLikeAction = null;
                }
            });
            
            likeConfirmNo.addEventListener('click', () => {
                likeConfirmModal.style.display = 'none';
                pendingLikeAction = null;
            });
            
            // Rating confirmation
            ratingConfirmYes.addEventListener('click', () => {
                if (pendingRatingAction) {
                    rateNovel(pendingRatingAction.novelId, pendingRatingAction.rating);
                    ratingConfirmModal.style.display = 'none';
                    pendingRatingAction = null;
                }
            });
            
            ratingConfirmNo.addEventListener('click', () => {
                ratingConfirmModal.style.display = 'none';
                pendingRatingAction = null;
            });
            
            // Rating preview stars hover
            ratingPreviewStars.querySelectorAll('.rating-preview-star').forEach(star => {
                star.addEventListener('mouseover', () => {
                    const rating = parseInt(star.getAttribute('data-rating'));
                    const stars = ratingPreviewStars.querySelectorAll('.rating-preview-star');
                    
                    stars.forEach(s => {
                        const sRating = parseInt(s.getAttribute('data-rating'));
                        if (sRating <= rating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                    
                    ratingPreviewValue.textContent = rating;
                });
            });
            
            // Close admin message popup
            closeMsgBtn.addEventListener('click', () => {
                adminMessagePopup.classList.remove('show');
            });
            
            // Admin message image upload
            messageImageUploadArea.addEventListener('click', () => {
                adminMessageImage.click();
            });
            
            adminMessageImage.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        messageImagePreview.src = e.target.result;
                        messageImagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Send admin message button
            sendAdminMessageBtn.addEventListener('click', sendAdminMessage);
            
            // Profile edit/delete buttons (delegated)
            document.addEventListener('click', (e) => {
                // Edit buttons
                if (e.target.closest('.edit-btn')) {
                    const btn = e.target.closest('.edit-btn');
                    const contentId = btn.getAttribute('data-id');
                    const type = btn.getAttribute('data-type');
                    editContent(contentId, type);
                }
                
                // Delete buttons
                if (e.target.closest('.delete-btn')) {
                    const btn = e.target.closest('.delete-btn');
                    const contentId = btn.getAttribute('data-id');
                    const type = btn.getAttribute('data-type');
                    deleteContent(contentId, type);
                }
                
                // Admin action buttons
                if (e.target.closest('.admin-add-coin-btn')) {
                    const btn = e.target.closest('.admin-add-coin-btn');
                    const userId = btn.getAttribute('data-user-id');
                    const userName = btn.getAttribute('data-user-name');
                    
                    const amount = prompt(`Enter amount of coins to add to ${userName}:`);
                    if (amount && !isNaN(amount) && parseInt(amount) > 0) {
                        const reason = prompt("Reason for adding coins (optional):");
                        manageUserCoins(userId, 'add', parseInt(amount), reason);
                    }
                }
                
                if (e.target.closest('.admin-remove-coin-btn')) {
                    const btn = e.target.closest('.admin-remove-coin-btn');
                    const userId = btn.getAttribute('data-user-id');
                    const userName = btn.getAttribute('data-user-name');
                    
                    const amount = prompt(`Enter amount of coins to remove from ${userName}:`);
                    if (amount && !isNaN(amount) && parseInt(amount) > 0) {
                        const reason = prompt("Reason for removing coins (optional):");
                        manageUserCoins(userId, 'remove', parseInt(amount), reason);
                    }
                }
                
                if (e.target.closest('.admin-delete-btn')) {
                    const btn = e.target.closest('.admin-delete-btn');
                    const contentId = btn.getAttribute('data-content-id');
                    const userId = btn.getAttribute('data-user-id');
                    const type = btn.getAttribute('data-type');
                    const title = btn.getAttribute('data-title') || btn.getAttribute('data-user-name');
                    
                    if (contentId && type) {
                        // Delete content
                        if (confirm(`Are you sure you want to delete this ${type} "${title}"?`)) {
                            deleteContent(contentId, type);
                        }
                    } else if (userId) {
                        // Delete user
                        if (confirm(`Are you sure you want to delete user "${title}"? This will also delete all their content.`)) {
                            showLoading("Deleting user...");
                            db.collection('users').doc(userId).delete()
                                .then(() => {
                                    showNotification("User deleted successfully", "success");
                                    loadAdminUsers();
                                    hideLoading();
                                })
                                .catch(error => {
                                    console.error("Error deleting user:", error);
                                    showNotification("Error deleting user", "error");
                                    hideLoading();
                                });
                        }
                    }
                }
            });
            
            // Admin tabs
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // Update active tab
                    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show correct content
                    document.querySelectorAll('.admin-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabId}Tab`).classList.add('active');
                    
                    // If messages tab is opened, load users for messaging
                    if (tabId === 'messages') {
                        loadAdminUsers();
                    }
                });
            });
            
            // Coin management buttons
            document.getElementById('addCoinsBtn').addEventListener('click', () => {
                const userId = document.getElementById('coinUserSelect').value;
                const amount = document.getElementById('coinAmount').value;
                const reason = document.getElementById('coinReason').value;
                
                if (!userId || !amount) {
                    showNotification("Please select a user and enter an amount", "error");
                    return;
                }
                
                manageUserCoins(userId, 'add', amount, reason);
            });
            
            document.getElementById('removeCoinsBtn').addEventListener('click', () => {
                const userId = document.getElementById('coinUserSelect').value;
                const amount = document.getElementById('coinAmount').value;
                const reason = document.getElementById('coinReason').value;
                
                if (!userId || !amount) {
                    showNotification("Please select a user and enter an amount", "error");
                    return;
                }
                
                manageUserCoins(userId, 'remove', amount, reason);
            });
            
            document.getElementById('setCoinsBtn').addEventListener('click', () => {
                const userId = document.getElementById('coinUserSelect').value;
                const amount = document.getElementById('coinAmount').value;
                const reason = document.getElementById('coinReason').value;
                
                if (!userId || !amount) {
                    showNotification("Please select a user and enter an amount", "error");
                    return;
                }
                
                manageUserCoins(userId, 'set', amount, reason);
            });
        });
    </script>
</body>
</html>